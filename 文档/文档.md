# OppenZeppelin

[æ–‡æ¡£ - OpenZeppelin ä¸­æ–‡æ–‡æ¡£ - ç™»é“¾ç¤¾åŒº](https://learnblockchain.cn/docs/openzeppelin/)



[å­¦ä¹  - OpenZeppelin ä¸­æ–‡æ–‡æ¡£ - ç™»é“¾ç¤¾åŒº](https://learnblockchain.cn/docs/openzeppelin/learn/)

# è®¾ç½® Node é¡¹ç›®

æ–°çš„è½¯ä»¶è¡Œä¸šé€šå¸¸ä»¥æ¯ä¸ªé¡¹ç›®å…±äº«ç›¸åŒçš„æŠ€æœ¯æ ˆå¼€å§‹ã€‚Ethereum ç”Ÿæ€ç³»ç»Ÿä¹Ÿä¸ä¾‹å¤–ï¼Œå¹¶ä¸”é€‰æ‹©çš„è¯­è¨€æ˜¯ [JavaScript](https://en.wikipedia.org/wiki/JavaScript)ã€‚è®¸å¤š Ethereum åº“ï¼ŒåŒ…æ‹¬ OpenZeppelin è½¯ä»¶ï¼Œéƒ½æ˜¯ç”¨ JavaScript æˆ–å…¶å˜ä½“ç¼–å†™çš„ã€‚

JavaScript ä»£ç ä¼ ç»Ÿä¸Šä½œä¸ºç½‘ç«™çš„ä¸€éƒ¨åˆ†åœ¨ Web æµè§ˆå™¨ä¸Šè¿è¡Œï¼Œä½†å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨ [Node](https://nodejs.org/) ä½œä¸ºç‹¬ç«‹è¿›ç¨‹æ‰§è¡Œã€‚

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ è®¾ç½® Node å¼€å‘ç¯å¢ƒï¼Œä½ éœ€è¦å®ƒæ¥ä½¿ç”¨ä¸åŒçš„ OpenZeppelin å·¥å…·å’Œå…¶ä»–ç¬¬ä¸‰æ–¹äº§å“ã€‚

|      | å¦‚æœä½ å·²ç»ç†Ÿæ‚‰ Nodeã€npm å’Œ Gitï¼Œè¯·éšæ—¶è·³è¿‡æœ¬æŒ‡å—ï¼ |
| ---- | --------------------------------------------------- |
|      |                                                     |

## å®‰è£… Node

æœ‰å¤šç§æ–¹æ³•å¯ä»¥åœ¨ä½ çš„æœºå™¨ä¸Šè·å– Nodeï¼šä½ å¯ä»¥é€šè¿‡ [åŒ…ç®¡ç†å™¨](https://nodejs.org/en/download/package-manager/) è·å–å®ƒï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½ [å®‰è£…ç¨‹åº](https://nodejs.org/en/download/prebuilt-installer)ã€‚

|      | å¦‚æœä½ æ­£åœ¨è¿è¡Œ Windowsï¼Œè¯·è€ƒè™‘ä½¿ç”¨ [Windows Subsystem for Linux](https://docs.microsoft.com/en-us/windows/nodejs/setup-on-wsl2)ï¼Œå› ä¸ºå¾ˆå¤šç”Ÿæ€ç³»ç»Ÿéƒ½æ˜¯ä¸º Linux ç¼–å†™çš„ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

å®Œæˆåï¼Œåœ¨ç»ˆç«¯ä¸Šè¿è¡Œ `node --version` ä»¥æ£€æŸ¥ä½ çš„å®‰è£…ï¼šä»»ä½• [æ´»åŠ¨æˆ–ç»´æŠ¤ç‰ˆæœ¬](https://nodejs.org/en/about/previous-releases) éƒ½åº”è¯¥ä¸å¤§å¤šæ•° Ethereum è½¯ä»¶å…¼å®¹ã€‚



```console
$ node --version
v20.17.0
```

## åˆ›å»ºä¸€ä¸ªé¡¹ç›®

JavaScript è½¯ä»¶é€šå¸¸æ†ç»‘åœ¨ *packages* ä¸­ï¼Œè¿™äº› *packages* é€šè¿‡ [npm registry](https://www.npmjs.com/) åˆ†å‘ã€‚ä¸€ä¸ª package åªæ˜¯ä¸€ä¸ªåŒ…å«åä¸º `package.json` æ–‡ä»¶çš„ç›®å½•ï¼Œç”¨äºæè¿° package çš„åç§°ã€ç‰ˆæœ¬ã€å†…å®¹ç­‰ã€‚å½“ä½ æ„å»ºè‡ªå·±çš„é¡¹ç›®æ—¶ï¼Œä½ å°†åˆ›å»ºä¸€ä¸ª packageï¼Œå³ä½¿ä½ ä¸æ‰“ç®—åˆ†å‘å®ƒã€‚

æ‰€æœ‰ Node å®‰è£…éƒ½åŒ…å«ä¸€ä¸ªç”¨äº npm registry çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œä½ å°†åœ¨å¼€å‘è‡ªå·±çš„é¡¹ç›®æ—¶ä½¿ç”¨å®ƒã€‚è¦å¯åŠ¨ä¸€ä¸ªæ–°é¡¹ç›®ï¼Œè¯·ä¸ºå…¶åˆ›å»ºä¸€ä¸ªç›®å½•ï¼š



```console
$ mkdir learn && cd learn
```

ç„¶åæˆ‘ä»¬å¯ä»¥åˆå§‹åŒ–å®ƒï¼š



```console
$ npm init -y
```

å°±è¿™ä¹ˆç®€å•ï¼ä½ æ–°åˆ›å»ºçš„ `package.json` æ–‡ä»¶å°†éšç€ä½ çš„é¡¹ç›®å¢é•¿è€Œå‘å±•ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨ `npm install` å®‰è£…ä¾èµ–é¡¹æ—¶ã€‚

|      | JavaScript å’Œ npm æ˜¯ä¸–ç•Œä¸Šä½¿ç”¨æœ€å¤šçš„è½¯ä»¶å·¥å…·ä¹‹ä¸€ï¼šå¦‚æœä½ æœ‰ä»»ä½•ç–‘é—®ï¼Œä½ ä¼šåœ¨ç½‘ä¸Šæ‰¾åˆ°å¤§é‡å…³äºå®ƒä»¬çš„ä¿¡æ¯ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

### ä½¿ç”¨ `npx`

npm registry ä¸­å­˜å‚¨çš„ package æœ‰ä¸¤ç§ç±»å‹ï¼š*libraries* å’Œ *executables*ã€‚å®‰è£…çš„ libraries åƒä»»ä½•å…¶ä»– JavaScript ä»£ç ä¸€æ ·ä½¿ç”¨ï¼Œä½† executables å¾ˆç‰¹åˆ«ã€‚

å®‰è£… node æ—¶åŒ…å«ç¬¬ä¸‰ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼šhttps://blog.npmjs.org/post/162869356040/introducing-npx-an-npm-package-runner[`npx`]ã€‚è¿™ç”¨äºè¿è¡Œä½ åœ¨é¡¹ç›®æœ¬åœ°å®‰è£…çš„ executablesã€‚

è™½ç„¶ [Hardhat](https://hardhat.org/) å¯ä»¥å…¨å±€å®‰è£…ï¼Œä½†æˆ‘ä»¬å»ºè®®åœ¨æ¯ä¸ªé¡¹ç›®ä¸­æœ¬åœ°å®‰è£…ï¼Œä»¥ä¾¿ä½ å¯ä»¥æŒ‰é¡¹ç›®æ§åˆ¶ç‰ˆæœ¬ã€‚

ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„æŒ‡å—ä¸­æ˜¾ç¤ºå®Œæ•´å‘½ä»¤ï¼ŒåŒ…æ‹¬ `npx`ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šå› ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ä¸åœ¨ç³»ç»Ÿè·¯å¾„ä¸­è€Œå‡ºç°é”™è¯¯ï¼š



```console
$ hardhat init
hardhat: command not found
$ npx hardhat init
ğŸ‘· Welcome to Hardhat v2.22.12 ğŸ‘·â€
? What do you want to do? â€¦
```

|      | è¿è¡Œ `npx` æ—¶ï¼Œè¯·ç¡®ä¿ä½ åœ¨é¡¹ç›®çš„ç›®å½•ä¸­ï¼å¦åˆ™ï¼Œå®ƒå°†å†æ¬¡ä¸‹è½½å®Œæ•´çš„ executable åªæ˜¯ä¸ºäº†è¿è¡Œè¯¥å‘½ä»¤ï¼Œè¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ *ä¸æ˜¯* ä½ æƒ³è¦çš„ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è¿›è¡Œè·Ÿè¸ª

åœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œä½ åº”è¯¥å°† [ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶](https://en.wikipedia.org/wiki/Version_control) æ·»åŠ åˆ°ä½ çš„é¡¹ç›®ä¸­ä»¥è·Ÿè¸ªæ›´æ”¹ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ€å¸¸ç”¨çš„å·¥å…·æ˜¯ [Git](https://git-scm.com/)ï¼Œé€šå¸¸ä¸ç”¨äºæ‰˜ç®¡ç›®çš„çš„ [GitHub](https://github.com/) ç»“åˆä½¿ç”¨ã€‚å®é™…ä¸Šï¼Œä½ å°†åœ¨æˆ‘ä»¬çš„ [GitHub repository](https://github.com/OpenZeppelin) ä¸­æ‰¾åˆ°æ‰€æœ‰ OpenZeppelin è½¯ä»¶çš„å®Œæ•´æºä»£ç å’Œå†å²è®°å½•ã€‚

|      | å¦‚æœä½ ä»¥å‰ä»æœªä½¿ç”¨è¿‡ Gitï¼Œä¸€ä¸ªå¥½çš„èµ·ç‚¹æ˜¯ [Git Handbook](https://guides.github.com/introduction/git-handbook/)ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

|      | ä¸è¦å°†åŠ©è®°è¯ã€ç§é’¥å’Œ API å¯†é’¥ç­‰æœºå¯†ä¿¡æ¯æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼ç¡®ä¿ä½ ä½¿ç”¨ [`.gitignore`](https://git-scm.com/docs/gitignore) æ–‡ä»¶æ¥ä¿æŠ¤æœºå¯†ä¿¡æ¯ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |



# å¼€å‘æ™ºèƒ½åˆçº¦

æ¬¢è¿æ¥åˆ°æ¿€åŠ¨äººå¿ƒçš„æ™ºèƒ½åˆçº¦å¼€å‘ä¸–ç•Œï¼æœ¬æŒ‡å—å°†å¼•å¯¼ä½ å¼€å§‹ç¼–å†™ Solidity åˆçº¦ï¼Œå†…å®¹åŒ…æ‹¬ï¼š

- [è®¾ç½® Solidity é¡¹ç›®](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#setting-up-a-solidity-project)
- [ç¼–è¯‘ Solidity æºä»£ç ](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#compiling-solidity-source-code)
- [æ·»åŠ æ›´å¤šåˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#adding-more-contracts)
- [ä½¿ç”¨ OpenZeppelin Contracts](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#using-openzeppelin-contracts)

## å…³äº Solidity

æœ¬æŒ‡å—ä¸ä¼šæ¶µç›–è¯­è¨€æ¦‚å¿µï¼Œå¦‚è¯­æ³•æˆ–å…³é”®å­—ã€‚ä¸ºæ­¤ï¼Œä½ éœ€è¦æŸ¥çœ‹ä»¥ä¸‹ç²¾é€‰å†…å®¹ï¼Œå…¶ä¸­åŒ…å«é¢å‘æ–°æ‰‹å’Œç»éªŒä¸°å¯Œçš„å¼€å‘äººå‘˜çš„ä¼˜ç§€å­¦ä¹ èµ„æºï¼š

- å¯¹äºä»¥å¤ªåŠå’Œæ™ºèƒ½åˆçº¦å¦‚ä½•å·¥ä½œçš„ä¸€èˆ¬æ¦‚è¿°ï¼Œå®˜æ–¹ç½‘ç«™æœ‰ä¸€ä¸ª [äº†è§£ä»¥å¤ªåŠ](https://ethereum.org/learn/) éƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…å«å¤§é‡é€‚åˆåˆå­¦è€…çš„å†…å®¹ã€‚
- å¦‚æœä½ æ˜¯è¿™é—¨è¯­è¨€çš„æ–°æ‰‹ï¼Œhttps://solidity.readthedocs.io/en/latest/introduction-to-smart-contracts.html[å®˜æ–¹ Solidity æ–‡æ¡£] æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ„æºã€‚è¯·æŸ¥çœ‹ä»–ä»¬çš„ [å®‰å…¨å»ºè®®](https://solidity.readthedocs.io/en/latest/security-considerations.html)ï¼Œå…¶ä¸­å¾ˆå¥½åœ°ä»‹ç»äº†åŒºå—é“¾å’Œä¼ ç»Ÿè½¯ä»¶å¹³å°ä¹‹é—´çš„åŒºåˆ«ã€‚
- Consensys çš„ [æœ€ä½³å®è·µ](https://consensys.github.io/smart-contract-best-practices/) éå¸¸å¹¿æ³›ï¼ŒåŒ…æ‹¬ [ç»è¿‡éªŒè¯çš„æ¨¡å¼](https://consensys.github.io/smart-contract-best-practices/development-recommendations/) ä»¥ä¾›å­¦ä¹ å’Œ [å·²çŸ¥çš„é™·é˜±](https://consensys.github.io/smart-contract-best-practices/attacks/) ä»¥é¿å…ã€‚
- åŸºäº Web çš„æ¸¸æˆ [Ethernaut](https://ethernaut.openzeppelin.com/?__hstc=64374704.8add8e9ba7adde50f6ef2419f1c8aad3.1765351015574.1765415709589.1765420487001.5&__hssc=64374704.14.1765420487001&__hsfp=1007129867) å°†è®©ä½ åœ¨æ™ºèƒ½åˆçº¦ä¸­å¯»æ‰¾ç»†å¾®çš„æ¼æ´ï¼Œéšç€ä½ é€šè¿‡éš¾åº¦è¶Šæ¥è¶Šå¤§çš„å…³å¡ã€‚

è¯´å®Œè¿™äº›ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼

## è®¾ç½®é¡¹ç›®

[åˆ›å»ºé¡¹ç›®](https://learnblockchain.cn/docs/openzeppelin/learn/setting-up-a-node-project.html#creating-a-project)åçš„ç¬¬ä¸€æ­¥æ˜¯å®‰è£…å¼€å‘å·¥å…·ã€‚

ä»¥å¤ªåŠæœ€æµè¡Œçš„å¼€å‘æ¡†æ¶æ˜¯ [Hardhat](https://hardhat.org/) å’Œ [Foundry](https://github.com/foundry-rs/foundry)ã€‚ æ¯ä¸€ä¸ªéƒ½æœ‰å…¶ä¼˜åŠ¿ï¼Œå¹¶ä¸”ç†Ÿæ‚‰ä½¿ç”¨å®ƒä»¬æ˜¯æœ‰ç”¨çš„ã€‚

åœ¨è¿™äº›æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Hardhat å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²æ™ºèƒ½åˆçº¦ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†ä»‹ç»å®ƒä¸ [ethers.js](https://docs.ethers.io/) çš„æœ€å¸¸è§ç”¨æ³•ã€‚

è¦å¼€å§‹ä½¿ç”¨ Hardhatï¼Œæˆ‘ä»¬å°†åœ¨ [é¡¹ç›®ç›®å½•](https://learnblockchain.cn/docs/openzeppelin/learn/setting-up-a-node-project.html#creating-a-project)ä¸­å®‰è£…å®ƒã€‚



```console
$ npm install --save-dev hardhat
```

å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ `npx hardhat`ã€‚ è¿™å°†åœ¨æˆ‘ä»¬çš„é¡¹ç›®ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª Hardhat é…ç½®æ–‡ä»¶ (`hardhat.config.js`)ã€‚



```console
$ npx hardhat
888    888                      888 888               888
888    888                      888 888               888
888    888                      888 888               888
8888888888  8888b.  888d888 .d88888 88888b.   8888b.  888888
888    888     "88b 888P"  d88" 888 888 "88b     "88b 888
888    888 .d888888 888    888  888 888  888 .d888888 888
888    888 888  888 888    Y88b 888 888  888 888  888 Y88b.
888    888 "Y888888 888     "Y88888 888  888 "Y888888  "Y888

ğŸ‘· Welcome to Hardhat v2.22.12 ğŸ‘·â€

âœ” What do you want to do? Â· Create an empty hardhat.config.js
å·²åˆ›å»ºé…ç½®æ–‡ä»¶
```

## ç¬¬ä¸€ä¸ªåˆçº¦

æˆ‘ä»¬å°†æˆ‘ä»¬çš„ Solidity æºæ–‡ä»¶ (`.sol`) å­˜å‚¨åœ¨ä¸€ä¸ª `contracts` ç›®å½•ä¸­ã€‚ è¿™ç›¸å½“äºä½ å¯èƒ½ä»å…¶ä»–è¯­è¨€ä¸­ç†Ÿæ‚‰çš„ `src` ç›®å½•ã€‚

æˆ‘ä»¬ç°åœ¨å¯ä»¥ç¼–å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç®€å•çš„æ™ºèƒ½åˆçº¦ï¼Œç§°ä¸º `Box`ï¼šå®ƒå°†å…è®¸äººä»¬å­˜å‚¨ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼å¯ä»¥åœ¨ä»¥åæ£€ç´¢ã€‚

æˆ‘ä»¬å°†æ­¤æ–‡ä»¶å¦å­˜ä¸º `contracts/Box.sol`ã€‚ æ¯ä¸ª `.sol` æ–‡ä»¶éƒ½åº”åŒ…å«å•ä¸ªåˆçº¦çš„ä»£ç ï¼Œå¹¶ä»¥å…¶å‘½åã€‚



```solidity
// contracts/Box.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Box {
    uint256 private _value;

    // å½“å­˜å‚¨çš„å€¼æ›´æ”¹æ—¶å‘å‡º
    event ValueChanged(uint256 value);

    // åœ¨åˆçº¦ä¸­å­˜å‚¨ä¸€ä¸ªæ–°å€¼
    function store(uint256 value) public {
        _value = value;
        emit ValueChanged(value);
    }

    // è¯»å–æœ€åå­˜å‚¨çš„å€¼
    function retrieve() public view returns (uint256) {
        return _value;
    }
}
```

## ç¼–è¯‘ Solidity

ä»¥å¤ªåŠè™šæ‹Ÿæœº (EVM) æ— æ³•ç›´æ¥æ‰§è¡Œ Solidity ä»£ç ï¼šæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†å…¶ç¼–è¯‘ä¸º EVM å­—èŠ‚ç ã€‚

æˆ‘ä»¬çš„ `Box.sol` åˆçº¦ä½¿ç”¨ Solidity 0.8ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é¦–å…ˆ [é…ç½® Hardhat ä»¥ä½¿ç”¨é€‚å½“çš„ solc ç‰ˆæœ¬](https://hardhat.org/config/#solidity-configuration)ã€‚

æˆ‘ä»¬åœ¨ `hardhat.config.js` ä¸­æŒ‡å®šä¸€ä¸ª Solidity 0.8 solc ç‰ˆæœ¬ã€‚



```js
// hardhat.config.js

/**
 * @type import('hardhat/config').HardhatUserConfig
 */
 module.exports = {
  solidity: "0.8.28",
};
```

ç„¶åå¯ä»¥é€šè¿‡è¿è¡Œå•ä¸ªç¼–è¯‘å‘½ä»¤æ¥å®ç°ç¼–è¯‘ï¼š

|      | å¦‚æœä½ ä¸ç†Ÿæ‚‰ `npx` å‘½ä»¤ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [Node é¡¹ç›®è®¾ç½®æŒ‡å—](https://learnblockchain.cn/docs/openzeppelin/learn/setting-up-a-node-project.html#using-npx)ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |



```console
$ npx hardhat compile
æˆåŠŸç¼–è¯‘ 1 ä¸ª Solidity æ–‡ä»¶ (evm target: paris)ã€‚
```

[``compile`](https://hardhat.org/guides/compile-contracts.html#compiling-your-contracts) å†…ç½®ä»»åŠ¡å°†è‡ªåŠ¨æŸ¥æ‰¾ `contracts` ç›®å½•ä¸­çš„æ‰€æœ‰åˆçº¦ï¼Œå¹¶ä½¿ç”¨ Solidity ç¼–è¯‘å™¨ä½¿ç”¨ [`hardhat.config.js`](https://hardhat.org/config/#solidity-configuration) ä¸­çš„é…ç½®ç¼–è¯‘å®ƒä»¬ã€‚

ä½ ä¼šæ³¨æ„åˆ°åˆ›å»ºäº†ä¸€ä¸ª `artifacts` ç›®å½•ï¼šå®ƒä¿å­˜äº†ç¼–è¯‘åçš„ artifactsï¼ˆå­—èŠ‚ç å’Œå…ƒæ•°æ®ï¼‰ï¼Œå®ƒä»¬æ˜¯ .json æ–‡ä»¶ã€‚ æœ€å¥½å°†æ­¤ç›®å½•æ·»åŠ åˆ°ä½ çš„ `.gitignore` ä¸­ã€‚

## æ·»åŠ æ›´å¤šåˆçº¦

éšç€ä½ çš„é¡¹ç›®å¢é•¿ï¼Œä½ å°†å¼€å§‹åˆ›å»ºæ›´å¤šç›¸äº’äº¤äº’çš„åˆçº¦ï¼šæ¯ä¸ªåˆçº¦éƒ½åº”å­˜å‚¨åœ¨è‡ªå·±çš„ `.sol` æ–‡ä»¶ä¸­ã€‚

è¦äº†è§£å®ƒçš„å¤–è§‚ï¼Œè®©æˆ‘ä»¬å‘æˆ‘ä»¬çš„ `Box` åˆçº¦æ·»åŠ ä¸€ä¸ªç®€å•çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿï¼šæˆ‘ä»¬å°†åœ¨ä¸€ä¸ªåä¸º `Auth` çš„åˆçº¦ä¸­å­˜å‚¨ä¸€ä¸ªç®¡ç†å‘˜åœ°å€ï¼Œå¹¶ä¸”åªå…è®¸ `Box` è¢« `Auth` å…è®¸çš„é‚£äº›å¸æˆ·ä½¿ç”¨ã€‚

å› ä¸ºç¼–è¯‘å™¨ä¼šé€‰å– `contracts` ç›®å½•å’Œå­ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰€ä»¥ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è‡ªç”±ç»„ç»‡ä½ çš„ä»£ç ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°† `Auth` åˆçº¦å­˜å‚¨åœ¨ä¸€ä¸ª `access-control` å­ç›®å½•ä¸­ï¼š



```solidity
// contracts/access-control/Auth.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

contract Auth {
    address private _administrator;

    constructor(address deployer) {
        // ä½¿åˆçº¦çš„éƒ¨ç½²è€…æˆä¸ºç®¡ç†å‘˜
        _administrator = deployer;
    }

    function isAdministrator(address user) public view returns (bool) {
        return user == _administrator;
    }
}
```

è¦ä» `Box` ä¸­ä½¿ç”¨æ­¤åˆçº¦ï¼Œæˆ‘ä»¬ä½¿ç”¨ `import` è¯­å¥ï¼Œé€šè¿‡å…¶ç›¸å¯¹è·¯å¾„å¼•ç”¨ `Auth`ï¼š



```solidity
// contracts/Box.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

// ä» access-control å­ç›®å½•å¯¼å…¥ Auth
import "./access-control/Auth.sol";

contract Box {
    uint256 private _value;
    Auth private _auth;

    event ValueChanged(uint256 value);

    constructor() {
        _auth = new Auth(msg.sender);
    }

    function store(uint256 value) public {
        // è¦æ±‚è°ƒç”¨è€…åœ¨ Auth ä¸­æ³¨å†Œä¸ºç®¡ç†å‘˜
        require(_auth.isAdministrator(msg.sender), "Unauthorized");

        _value = value;
        emit ValueChanged(value);
    }

    function retrieve() public view returns (uint256) {
        return _value;
    }
}
```

è·¨å¤šä¸ªåˆçº¦åˆ†ç¦»å…³æ³¨ç‚¹æ˜¯ä¿æŒæ¯ä¸ªåˆçº¦ç®€å•çš„ç»ä½³æ–¹å¼ï¼Œå¹¶ä¸”é€šå¸¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ã€‚

ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯å°†ä½ çš„ä»£ç æ‹†åˆ†ä¸ºæ¨¡å—çš„å”¯ä¸€æ–¹æ³•ã€‚ ä½ è¿˜å¯ä»¥ä½¿ç”¨ *ç»§æ‰¿* åœ¨ Solidity ä¸­è¿›è¡Œå°è£…å’Œä»£ç é‡ç”¨ï¼Œæˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çœ‹åˆ°ã€‚

## ä½¿ç”¨ OpenZeppelin Contracts

å¯é‡ç”¨çš„æ¨¡å—å’Œåº“æ˜¯ä¼˜ç§€è½¯ä»¶çš„åŸºçŸ³ã€‚ [**OpenZeppelin Contracts**](https://learnblockchain.cn/docs/openzeppelin/contracts/5.x/) åŒ…å«è®¸å¤šæœ‰ç”¨çš„æ™ºèƒ½åˆçº¦æ„å»ºå—ã€‚ å¹¶ä¸”åœ¨å®ƒä»¬çš„åŸºç¡€ä¸Šæ„å»ºæ—¶ï¼Œä½ å¯ä»¥æ”¾å¿ƒï¼šå®ƒä»¬å·²ç»è¿‡å¤šæ¬¡å®¡è®¡ï¼Œå®ƒä»¬çš„å®‰å…¨æ€§å¾—åˆ°äº†å®æˆ˜æ£€éªŒã€‚

### å…³äºç»§æ‰¿

åº“ä¸­çš„è®¸å¤šåˆçº¦ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸å¸Œæœ›ä½ æŒ‰åŸæ ·éƒ¨ç½²å®ƒä»¬ã€‚ ç›¸åï¼Œä½ å°†ä½¿ç”¨å®ƒä»¬ä½œä¸ºèµ·ç‚¹ï¼Œé€šè¿‡å‘å®ƒä»¬æ·»åŠ åŠŸèƒ½æ¥æ„å»ºä½ è‡ªå·±çš„åˆçº¦ã€‚ Solidity æä¾› *å¤šé‡ç»§æ‰¿* ä½œä¸ºå®ç°æ­¤ç›®çš„çš„ä¸€ç§æœºåˆ¶ï¼šæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [Solidity æ–‡æ¡£](https://solidity.readthedocs.io/en/latest/contracts.html#inheritance)ã€‚

ä¾‹å¦‚ï¼Œ[`Ownable`](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#contracts:api:access.adoc#Ownable) åˆçº¦å°†éƒ¨ç½²è€…å¸æˆ·æ ‡è®°ä¸ºåˆçº¦çš„æ‰€æœ‰è€…ï¼Œå¹¶æä¾›ä¸€ä¸ªåä¸º `onlyOwner` çš„ä¿®é¥°ç¬¦ã€‚ å½“åº”ç”¨äºä¸€ä¸ªå‡½æ•°æ—¶ï¼Œ`onlyOwner` å°†å¯¼è‡´æ‰€æœ‰ä¸æ˜¯æ¥è‡ªæ‰€æœ‰è€…å¸æˆ·çš„å‡½æ•°è°ƒç”¨éƒ½ revertã€‚ ç”¨äº [transfer](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#contracts:api:access.adoc#Ownable-transferOwnership-address-) å’Œ [renounce](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#contracts:api:access.adoc#Ownable-renounceOwnership--) æ‰€æœ‰æƒçš„å‡½æ•°ä¹Ÿå¯ç”¨ã€‚

ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨æ—¶ï¼Œç»§æ‰¿æˆä¸ºä¸€ç§å¼ºå¤§çš„æœºåˆ¶ï¼Œå…è®¸æ¨¡å—åŒ–ï¼Œè€Œæ— éœ€ä½ éƒ¨ç½²å’Œç®¡ç†å¤šä¸ªåˆçº¦ã€‚

### å¯¼å…¥ OpenZeppelin Contracts

å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸‹è½½ OpenZeppelin Contracts åº“çš„æœ€æ–°å‘å¸ƒç‰ˆæœ¬ï¼š



```console
$ npm install @openzeppelin/contracts
```

|      | ä½ åº”è¯¥å§‹ç»ˆä½¿ç”¨æ¥è‡ªè¿™äº›å·²å‘å¸ƒç‰ˆæœ¬çš„åº“ï¼šå°†åº“æºä»£ç å¤åˆ¶ç²˜è´´åˆ°ä½ çš„é¡¹ç›®ä¸­æ˜¯ä¸€ç§å±é™©çš„åšæ³•ï¼Œå¾ˆå®¹æ˜“åœ¨ä½ çš„åˆçº¦ä¸­å¼•å…¥å®‰å…¨æ¼æ´ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

è¦ä½¿ç”¨å…¶ä¸­ä¸€ä¸ª OpenZeppelin Contractsï¼Œè¯· `import` å®ƒï¼Œæ–¹æ³•æ˜¯åœ¨å…¶è·¯å¾„å‰åŠ ä¸Š `@openzeppelin/contracts`ã€‚ ä¾‹å¦‚ï¼Œä¸ºäº†æ›¿æ¢æˆ‘ä»¬è‡ªå·±çš„ [`Auth`](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#auth-contract) åˆçº¦ï¼Œæˆ‘ä»¬å°†å¯¼å…¥ `@openzeppelin/contracts/access/Ownable.sol` ä»¥å°†è®¿é—®æ§åˆ¶æ·»åŠ åˆ° `Box`ï¼š



```solidity
// contracts/Box.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

// ä» OpenZeppelin Contracts åº“å¯¼å…¥ Ownable
import "@openzeppelin/contracts/access/Ownable.sol";

// ä½¿ Box ä» Ownable åˆçº¦ç»§æ‰¿
contract Box is Ownable {
    uint256 private _value;

    event ValueChanged(uint256 value);

    constructor() Ownable(msg.sender) {}

    // onlyOwner ä¿®é¥°ç¬¦é™åˆ¶äº†è°å¯ä»¥è°ƒç”¨ store å‡½æ•°
    function store(uint256 value) public onlyOwner {
        _value = value;
        emit ValueChanged(value);
    }

    function retrieve() public view returns (uint256) {
        return _value;
    }
}
```

[OpenZeppelin Contracts æ–‡æ¡£](https://learnblockchain.cn/docs/openzeppelin/contracts/5.x/) æ˜¯å­¦ä¹ å¼€å‘å®‰å…¨æ™ºèƒ½åˆçº¦ç³»ç»Ÿçš„å¥½åœ°æ–¹ã€‚ å®ƒæä¾›äº†æŒ‡å—å’Œè¯¦ç»†çš„ API å‚è€ƒï¼šä¾‹å¦‚ï¼Œè¯·å‚é˜… [Access Control](https://learnblockchain.cn/docs/openzeppelin/contracts/5.x/access-control) æŒ‡å—ï¼Œä»¥äº†è§£æ›´å¤šå…³äºä¸Šé¢ä»£ç ç¤ºä¾‹ä¸­ä½¿ç”¨çš„ `Ownable` åˆçº¦çš„ä¿¡æ¯ã€‚

## ä¸‹ä¸€æ­¥



# éƒ¨ç½²å’Œäº¤äº’æ™ºèƒ½åˆçº¦

ä¸å¤§å¤šæ•°è½¯ä»¶ä¸åŒï¼Œæ™ºèƒ½åˆçº¦ä¸æ˜¯åœ¨ä½ çš„ç”µè„‘æˆ–æŸäººçš„æœåŠ¡å™¨ä¸Šè¿è¡Œï¼šå®ƒä»¬å­˜åœ¨äº Ethereum ç½‘ç»œæœ¬èº«ã€‚è¿™æ„å‘³ç€ä¸å®ƒä»¬çš„äº¤äº’ä¸æ›´ä¼ ç»Ÿçš„åº”ç”¨ç¨‹åºç•¥æœ‰ä¸åŒã€‚

æœ¬æŒ‡å—å°†æ¶µç›–ä½ å¼€å§‹ä½¿ç”¨åˆçº¦æ‰€éœ€äº†è§£çš„ä¸€åˆ‡ï¼ŒåŒ…æ‹¬ï¼š

- [è®¾ç½®æœ¬åœ°åŒºå—é“¾](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#local-blockchain)
- [éƒ¨ç½²æ™ºèƒ½åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#deploying-a-smart-contract)
- [ä»æ§åˆ¶å°äº¤äº’](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#interacting-from-the-console)
- [ä»¥ç¼–ç¨‹æ–¹å¼äº¤äº’](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#interacting-programmatically)

## è®¾ç½®æœ¬åœ°åŒºå—é“¾

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªå¯ä»¥éƒ¨ç½²åˆçº¦çš„ç¯å¢ƒã€‚Ethereum åŒºå—é“¾ï¼ˆé€šå¸¸ç§°ä¸ºâ€œmainnetâ€ï¼Œå³â€œä¸»ç½‘ç»œâ€ï¼‰éœ€è¦èŠ±è´¹çœŸé‡‘ç™½é“¶æ‰èƒ½ä½¿ç”¨ï¼Œä»¥ Etherï¼ˆå…¶åŸç”Ÿè´§å¸ï¼‰çš„å½¢å¼ã€‚è¿™ä½¿å¾—å®ƒåœ¨å°è¯•æ–°æƒ³æ³•æˆ–å·¥å…·æ—¶æˆä¸ºä¸€ä¸ªç³Ÿç³•çš„é€‰æ‹©ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå­˜åœ¨è®¸å¤šâ€œtestnetsâ€ï¼ˆå³â€œæµ‹è¯•ç½‘ç»œâ€ï¼‰ï¼šè¿™äº›åŒ…æ‹¬ Sepolia å’Œ Holesky åŒºå—é“¾ã€‚å®ƒä»¬çš„å·¥ä½œæ–¹å¼ä¸ mainnet éå¸¸ç›¸ä¼¼ï¼Œä½†æœ‰ä¸€ä¸ªåŒºåˆ«ï¼šä½ å¯ä»¥å…è´¹è·å¾—è¿™äº›ç½‘ç»œçš„ Etherï¼Œå› æ­¤ä½¿ç”¨å®ƒä»¬ä¸éœ€è¦èŠ±è´¹ä¸€åˆ†é’±ã€‚ä½†æ˜¯ï¼Œä½ ä»ç„¶éœ€è¦å¤„ç†ç§é’¥ç®¡ç†ã€12 ç§’æˆ–æ›´é•¿çš„åŒºå—æ—¶é—´ï¼Œä»¥åŠå®é™…è·å¾—è¿™äº›å…è´¹çš„ Etherã€‚

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ€å¥½ä½¿ç”¨_æœ¬åœ°_åŒºå—é“¾ã€‚å®ƒåœ¨ä½ çš„æœºå™¨ä¸Šè¿è¡Œï¼Œä¸éœ€è¦è®¿é—®äº’è”ç½‘ï¼Œä¸ºä½ æä¾›æ‰€æœ‰ä½ éœ€è¦çš„ Etherï¼Œå¹¶ç«‹å³æŒ–æ˜åŒºå—ã€‚è¿™äº›åŸå› ä¹Ÿä½¿æœ¬åœ°åŒºå—é“¾éå¸¸é€‚åˆ [è‡ªåŠ¨åŒ–æµ‹è¯•](https://learnblockchain.cn/docs/openzeppelin/learn/writing-automated-tests.html#setting-up-a-testing-environment)ã€‚

|      | å¦‚æœä½ æƒ³å­¦ä¹ å¦‚ä½•åœ¨_å…¬å…±_åŒºå—é“¾ï¼ˆå¦‚ Ethereum æµ‹è¯•ç½‘ç»œï¼‰ä¸Šéƒ¨ç½²å’Œä½¿ç”¨åˆçº¦ï¼Œè¯·å‰å¾€æˆ‘ä»¬çš„ [è¿æ¥åˆ°å…¬å…±æµ‹è¯•ç½‘ç»œ](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html)æŒ‡å—ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

Hardhat è‡ªå¸¦ä¸€ä¸ªå†…ç½®çš„æœ¬åœ°åŒºå—é“¾ï¼Œå³ [Hardhat ç½‘ç»œ](https://hardhat.org/hardhat-network/)ã€‚

å¯åŠ¨åï¼ŒHardhat ç½‘ç»œå°†åˆ›å»ºä¸€ç»„æœªé”å®šçš„å¸æˆ·å¹¶ä¸ºå…¶æä¾› Etherã€‚



```console
$ npx hardhat node
------
D:\node-code\learn> npx hardhat node
Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/

Accounts
========

WARNING: Funds sent on live network to accounts with publicly known private keys WILL BE LOST.

Account #0:  0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266 (10000 ETH)
Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

Account #1:  0x70997970c51812dc3a010c7d01b50e0d17dc79c8 (10000 ETH)
Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d

Account #2:  0x3c44cdddb6a900fa2b585dd299e03d12fa4293bc (10000 ETH)
Private Key: 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a
```

Hardhat ç½‘ç»œå°†æ‰“å°å‡ºå…¶åœ°å€ `http://127.0.0.1:8545`ï¼Œä»¥åŠå¯ç”¨å¸æˆ·åŠå…¶ç§é’¥çš„åˆ—è¡¨ã€‚

è¯·è®°ä½ï¼Œæ¯æ¬¡è¿è¡Œ Hardhat ç½‘ç»œæ—¶ï¼Œå®ƒéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æœ¬åœ°åŒºå—é“¾ - **ä¸ä¼š**ä¿ç•™å…ˆå‰è¿è¡Œçš„çŠ¶æ€ã€‚è¿™å¯¹äºçŸ­æœŸå®éªŒæ¥è¯´æ˜¯å¯ä»¥çš„ï¼Œä½†è¿™æ„å‘³ç€ä½ éœ€è¦åœ¨è¿™äº›æŒ‡å—çš„æ•´ä¸ªè¿‡ç¨‹ä¸­æ‰“å¼€ä¸€ä¸ªçª—å£è¿è¡Œ Hardhat ç½‘ç»œã€‚

|      | å½“æœªæŒ‡å®šç½‘ç»œä¸”æœªé…ç½®é»˜è®¤ç½‘ç»œæˆ–é»˜è®¤ç½‘ç»œè®¾ç½®ä¸º `hardhat` æ—¶ï¼ŒHardhat å°†å§‹ç»ˆå¯åŠ¨ä¸€ä¸ª **Hardhat ç½‘ç»œ**å®ä¾‹ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

|      | ä½ ä¹Ÿå¯ä»¥åœ¨_https://geth.ethereum.org/getting-started/dev-mode[å¼€å‘æ¨¡å¼]_ä¸‹è¿è¡Œä¸€ä¸ªçœŸæ­£çš„ Ethereum èŠ‚ç‚¹ã€‚è¿™äº›è®¾ç½®èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•å’Œå¼€å‘æ–¹é¢ä¸å¤Ÿçµæ´»ï¼Œä½†æ›´èƒ½ä»£è¡¨çœŸå®çš„ç½‘ç»œã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## éƒ¨ç½²æ™ºèƒ½åˆçº¦

åœ¨ [å¼€å‘æ™ºèƒ½åˆçº¦æŒ‡å—](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html)ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒã€‚

å¦‚æœä½ è¿˜æ²¡æœ‰å®Œæˆæ­¤è®¾ç½®ï¼Œè¯· [åˆ›å»º](https://learnblockchain.cn/docs/openzeppelin/learn/setting-up-a-node-project.html#creating-a-project)å¹¶ [è®¾ç½®](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#setting-up-a-solidity-project)é¡¹ç›®ï¼Œç„¶å [åˆ›å»º](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#first-contract)å¹¶ [ç¼–è¯‘](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#compiling-solidity-source-code)æˆ‘ä»¬çš„ Box æ™ºèƒ½åˆçº¦ã€‚

å®Œæˆé¡¹ç›®è®¾ç½®åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥éƒ¨ç½²åˆçº¦äº†ã€‚æˆ‘ä»¬å°†éƒ¨ç½² [å¼€å‘æ™ºèƒ½åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#box-contract)æŒ‡å—ä¸­çš„ `Box`ã€‚ç¡®ä¿ä½ æœ‰ä¸€ä¸ª [Box](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#box-contract) çš„å‰¯æœ¬åœ¨ `contracts/Box.sol` ä¸­ã€‚

Hardhat ä½¿ç”¨ [å£°æ˜å¼éƒ¨ç½²](https://hardhat.org/hardhat-runner/docs/guides/deploying)æˆ– [è„šæœ¬](https://hardhat.org/hardhat-runner/docs/advanced/scripts#writing-scripts-with-hardhat)æ¥éƒ¨ç½²åˆçº¦ã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥éƒ¨ç½²æˆ‘ä»¬çš„ Box åˆçº¦ã€‚æˆ‘ä»¬å°†æ­¤æ–‡ä»¶å¦å­˜ä¸º `scripts/deploy.js`ã€‚



```js
// scripts/deploy.js
//  æ‰¾ä¸åˆ°ethersï¼Œå‚è€ƒè¿™ä¸ªåœ°å€ https://www.npmjs.com/package/@nomicfoundation/hardhat-ethers
import { network } from "hardhat";
const { ethers } = await network.connect();

async function main () {
  // We get the contract to deploy
  // æˆ‘ä»¬å¾—åˆ°äº†è¦éƒ¨ç½²çš„åˆçº¦
  const Box = await ethers.getContractFactory('Box');
  console.log('Deploying Box...');
  // éƒ¨ç½² Box ä¸­...
  const box = await Box.deploy();
  await box.waitForDeployment();
  console.log('Box deployed to:', await box.getAddress());
  // Box éƒ¨ç½²åˆ°ï¼š
}

main()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
```

æˆ‘ä»¬åœ¨è„šæœ¬ä¸­ä½¿ç”¨ [ethers](https://github.com/ethers-io/ethers.js)ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®‰è£…å®ƒå’Œ [@nomicfoundation/hardhat-ethers æ’ä»¶](https://hardhat.org/hardhat-runner/plugins/nomicfoundation-hardhat-ethers)ã€‚



```console
$ npm install --save-dev @nomicfoundation/hardhat-ethers ethers
```

æˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„ [é…ç½®](https://hardhat.org/config/)ä¸­æ·»åŠ æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ `@nomicfoundation/hardhat-ethers` æ’ä»¶ã€‚



```js
// hardhat.config.js   æ‰¾ä¸åˆ°ethersï¼Œå‚è€ƒè¿™ä¸ªåœ°å€ https://www.npmjs.com/package/@nomicfoundation/hardhat-ethers
import { configVariable, defineConfig } from "hardhat/config";
import hardhatEthers from "@nomicfoundation/hardhat-ethers";


export default defineConfig({
  plugins: [hardhatToolboxViemPlugin, hardhatEthers],
    .....
```

ä½¿ç”¨ `run` å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å°† `Box` åˆçº¦éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ ([Hardhat Network](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#local-blockchain))ï¼š



```console
$ npx hardhat run --network localhost scripts/deploy.js

-------

D:\node-code\learn>npx hardhat run --network localhost scripts/deploy.js

Deploying Box...
Box deployed to: 0x5FbDB2315678afecb367f032d93F642f64180aa3


æµ‹è¯•ç½‘ç»œç«¯
Account #19: 0x8626f6940e2eb28930efb4cef49b2d1f2c9c1199 (10000 ETH)
Private Key: 0xdf57089febbacf7ba0bc227dafbffa9fc08a93fdc68e1e42411a14efcf23656e

WARNING: Funds sent on live network to accounts with publicly known private keys WILL BE LOST.

eth_accounts
eth_blockNumber
eth_estimateGas
eth_getBlockByNumber
eth_feeHistory
eth_maxPriorityFeePerGas
eth_sendTransaction
  Contract deployment: Box
  Contract address:    0x5fbdb2315678afecb367f032d93f642f64180aa3
  Transaction:         0xd27beb1a8e4d94743356220b4cee9004dee7c38e823b0dca017ffb585269ceba
  From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
  Value:               0 ETH
  Gas used:            339408 of 339408
  Block #1:            0xaef44bc2553887da9fb47bf125c4b1ee21111e09d3f08dc01962dd67f442b37d

eth_getTransactionByHash	
eth_getTransactionReceipt
```

|      | Hardhat ä¸ä¼šè·Ÿè¸ªä½ éƒ¨ç½²çš„åˆçº¦ã€‚æˆ‘ä»¬åœ¨è„šæœ¬ä¸­æ˜¾ç¤ºäº†éƒ¨ç½²çš„åœ°å€ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œ`0x5FbDB2315678afecb367f032d93F642f64180aa3`ï¼‰ã€‚è¿™åœ¨ä»¥ç¼–ç¨‹æ–¹å¼ä¸å®ƒä»¬äº¤äº’æ—¶ä¼šå¾ˆæœ‰ç”¨ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

å…¨éƒ¨å®Œæˆï¼åœ¨å®é™…çš„ç½‘ç»œä¸Šï¼Œæ­¤è¿‡ç¨‹éœ€è¦èŠ±è´¹å‡ ç§’é’Ÿçš„æ—¶é—´ï¼Œä½†åœ¨æœ¬åœ°åŒºå—é“¾ä¸Šå‡ ä¹æ˜¯å³æ—¶çš„ã€‚

|      | å¦‚æœä½ é‡åˆ°è¿æ¥é”™è¯¯ï¼Œè¯·ç¡®ä¿ä½ åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œ [æœ¬åœ°åŒºå—é“¾](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#local-blockchain)ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

|      | è¯·è®°ä½ï¼Œæœ¬åœ°åŒºå—é“¾**ä¸ä¼š**åœ¨å¤šæ¬¡è¿è¡Œä¸­ä¿ç•™å…¶çŠ¶æ€ï¼å¦‚æœä½ å…³é—­æœ¬åœ°åŒºå—é“¾è¿›ç¨‹ï¼Œåˆ™å¿…é¡»é‡æ–°éƒ¨ç½²åˆçº¦ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## ä»æ§åˆ¶å°äº¤äº’

æœ‰äº†æˆ‘ä»¬ [éƒ¨ç½²çš„](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#deploying-a-smart-contract) `Box` åˆçº¦ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨å®ƒã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ [Hardhat æ§åˆ¶å°](https://hardhat.org/guides/hardhat-console.html)ä¸æˆ‘ä»¬åœ¨ localhost ç½‘ç»œä¸Šéƒ¨ç½²çš„ `Box` åˆçº¦è¿›è¡Œäº¤äº’ã€‚

|      | æˆ‘ä»¬éœ€è¦æŒ‡å®šåœ¨éƒ¨ç½²è„šæœ¬ä¸­æ˜¾ç¤ºçš„ `Box` åˆçº¦çš„åœ°å€ã€‚ |
| ---- | ------------------------------------------------- |
|      |                                                   |

|      | é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬æ˜¾å¼åœ°è®¾ç½® Hardhat è¿æ¥æˆ‘ä»¬çš„æ§åˆ¶å°ä¼šè¯çš„ç½‘ç»œã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼ŒHardhat å°†é»˜è®¤ä½¿ç”¨ä¸€ä¸ªæ–°çš„ä¸´æ—¶ç½‘ç»œï¼Œæˆ‘ä»¬çš„ Box åˆçº¦å°†ä¸ä¼šéƒ¨ç½²åˆ°è¯¥ç½‘ç»œã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |



```console
D:\node-code\learn>npx hardhat console --network localhost
> const { ethers } = await network.connect();
undefined
> const Box = await ethers.getContractFactory('Box');
undefined
> const box = Box.attach('0x5FbDB2315678afecb367f032d93F642f64180aa3')
undefined

```

### å‘é€äº¤æ˜“

`Box` çš„ç¬¬ä¸€ä¸ªå‡½æ•° `store` æ¥æ”¶ä¸€ä¸ªæ•´æ•°å€¼å¹¶å°†å…¶å­˜å‚¨åœ¨åˆçº¦å­˜å‚¨ä¸­ã€‚ç”±äºæ­¤å‡½æ•°_ä¿®æ”¹_äº†åŒºå—é“¾çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦_å‘é€äº¤æ˜“_åˆ°åˆçº¦ä»¥æ‰§è¡Œå®ƒã€‚

æˆ‘ä»¬å°†å‘é€ä¸€ä¸ªäº¤æ˜“æ¥è°ƒç”¨å¸¦æœ‰æ•°å€¼çš„ `store` å‡½æ•°ï¼š

```console
> await box.store(42)
ContractTransactionResponse {
  provider: HardhatEthersProvider {},
  blockNumber: 2,
  blockHash: '0x7c34615c69b0e7a2a61bda0a77b601af6b54d539a8160535f1e449d30b827a65',
  index: undefined,
  hash: '0xd98781197f0a6716619d9fc945155b5c465dee3f6e81618321977fc2d044fe30',
  type: 2,
  to: '0x5FbDB2315678afecb367f032d93F642f64180aa3',
  from: '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',
  nonce: 1,
  gasLimit: 47167n,
  gasPrice: 972126372n,
  maxPriorityFeePerGas: 232421875n,
  maxFeePerGas: 972126372n,
  maxFeePerBlobGas: null,
  data: '0x6057361d000000000000000000000000000000000000000000000000000000000000002a',
  value: 0n,
  chainId: 31337n,
  signature: Signature { r: 0x9520a7729e0a9d1a4e30060bbe8b9188286f2e3e739465b316c1d12b4d6828fb, s: 0x01f76ab5774b1b97964536a2004d8d9a2d7da34b56d6d20058c7f790e98435f0, v: 28 },
  accessList: [],
  blobVersionedHashes: null,
  authorizationList: null
}
```

### æŸ¥è¯¢çŠ¶æ€

`Box` çš„å¦ä¸€ä¸ªå‡½æ•°ç§°ä¸º `retrieve`ï¼Œå®ƒè¿”å›å­˜å‚¨åœ¨åˆçº¦ä¸­çš„æ•´æ•°å€¼ã€‚è¿™æ˜¯åŒºå—é“¾çŠ¶æ€çš„_æŸ¥è¯¢_ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å‘é€äº¤æ˜“ï¼š



```console
> await box.retrieve()
42n
```

ç”±äºæŸ¥è¯¢ä»…è¯»å–çŠ¶æ€å¹¶ä¸”ä¸å‘é€äº¤æ˜“ï¼Œå› æ­¤æ²¡æœ‰è¦æŠ¥å‘Šçš„äº¤æ˜“å“ˆå¸Œã€‚è¿™ä¹Ÿæ„å‘³ç€ä½¿ç”¨æŸ¥è¯¢ä¸ä¼šèŠ±è´¹ä»»ä½• Etherï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•ç½‘ç»œä¸Šå…è´¹ä½¿ç”¨ã€‚

|      | æˆ‘ä»¬çš„ `Box` åˆçº¦è¿”å› `uint256`ï¼Œå¯¹äº JavaScript æ¥è¯´è¿™ä¸ªæ•°å­—å¤ªå¤§äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªå¤§æ•°å­—å¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `(await box.retrieve()).toString()` å°†å¤§æ•°å­—æ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |



```console
> (await box.retrieve()).toString()
'42'
```

|      | è¦äº†è§£æ›´å¤šå…³äºä½¿ç”¨æ§åˆ¶å°çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [Hardhat æ–‡æ¡£](https://hardhat.org/guides/hardhat-console.html)ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

![image-20251211110835910](C:\Users\laohu\AppData\Roaming\Typora\typora-user-images\image-20251211110835910.png)

## ä»¥ç¼–ç¨‹æ–¹å¼äº¤äº’

æ§åˆ¶å°å¯¹äºåŸå‹è®¾è®¡å’Œè¿è¡Œä¸€æ¬¡æ€§æŸ¥è¯¢æˆ–äº¤æ˜“å¾ˆæœ‰ç”¨ã€‚ä½†æ˜¯ï¼Œæœ€ç»ˆä½ å°†å¸Œæœ›ä»ä½ è‡ªå·±çš„ä»£ç ä¸­ä¸ä½ çš„åˆçº¦è¿›è¡Œäº¤äº’ã€‚

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä» JavaScript ä¸æˆ‘ä»¬çš„åˆçº¦è¿›è¡Œäº¤äº’ï¼Œå¹¶ä½¿ç”¨ [Hardhat è¿è¡Œå¸¦æœ‰ Hardhat é…ç½®çš„è„šæœ¬](https://hardhat.org/guides/scripts.html)ã€‚

|      | è¯·è®°ä½ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»– JavaScript åº“å¯ç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ä½ æœ€å–œæ¬¢çš„ä»»ä½•ä¸€ä¸ªã€‚ä¸€æ—¦éƒ¨ç½²äº†åˆçº¦ï¼Œä½ å°±å¯ä»¥é€šè¿‡ä»»ä½•åº“ä¸å®ƒè¿›è¡Œäº¤äº’ï¼ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

### è®¾ç½®

è®©æˆ‘ä»¬å¼€å§‹åœ¨ä¸€ä¸ªæ–°çš„ `scripts/index.js` æ–‡ä»¶ä¸­ç¼–å†™ä»£ç ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­ç¼–å†™æˆ‘ä»¬çš„ JavaScript ä»£ç ï¼Œä»ä¸€äº›æ ·æ¿ä»£ç å¼€å§‹ï¼ŒåŒ…æ‹¬ç”¨äº [ç¼–å†™å¼‚æ­¥ä»£ç ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function)ã€‚



```js
// scripts/index.js
async function main () {
  // Our code will go here
  // æˆ‘ä»¬çš„ä»£ç å°†æ”¾åœ¨è¿™é‡Œ
}

main()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘æœ¬åœ°èŠ‚ç‚¹è¯¢é—®ä¸€äº›ä¿¡æ¯æ¥æµ‹è¯•æˆ‘ä»¬çš„è®¾ç½®ï¼Œä¾‹å¦‚å·²å¯ç”¨çš„å¸æˆ·åˆ—è¡¨ï¼š



```js
// Retrieve accounts from the local node
// ä»æœ¬åœ°èŠ‚ç‚¹æ£€ç´¢å¸æˆ·
const accounts = (await ethers.getSigners()).map(signer => signer.address);
console.log(accounts);
```

|      | æˆ‘ä»¬ä¸ä¼šåœ¨æ¯ä¸ªä»£ç ç‰‡æ®µä¸Šé‡å¤æ ·æ¿ä»£ç ï¼Œä½†è¯·ç¡®ä¿å§‹ç»ˆåœ¨æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ `main` å‡½æ•°_å†…éƒ¨_ç¼–å†™ä»£ç ï¼ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

ä½¿ç”¨ `hardhat run` è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œå¹¶æ£€æŸ¥ä½ æ˜¯å¦è·å¾—äº†å“åº”ä¸­çš„å¯ç”¨å¸æˆ·åˆ—è¡¨ã€‚



```console
$ npx hardhat run --network localhost ./scripts/index.js
[
  '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',
  '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
...
]
```

è¿™äº›å¸æˆ·åº”ä¸ä½ ä¹‹å‰å¯åŠ¨ [æœ¬åœ°åŒºå—é“¾](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#local-blockchain) æ—¶æ˜¾ç¤ºçš„å¸æˆ·åŒ¹é…ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†ç¬¬ä¸€ä¸ªä»åŒºå—é“¾ä¸­è·å–æ•°æ®çš„ä»£ç ç‰‡æ®µï¼Œè®©æˆ‘ä»¬å¼€å§‹ä½¿ç”¨æˆ‘ä»¬çš„åˆçº¦ã€‚è®°ä½ï¼Œæˆ‘ä»¬æ­£åœ¨æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ `main` å‡½æ•°_å†…éƒ¨_æ·»åŠ æˆ‘ä»¬çš„ä»£ç ã€‚

### è·å–åˆçº¦å®ä¾‹

ä¸ºäº†ä¸æˆ‘ä»¬éƒ¨ç½²çš„ [`Box`](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#box-contract) åˆçº¦è¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [ethers åˆçº¦å®ä¾‹](https://docs.ethers.org/v6/api/contract/)ã€‚

ethers åˆçº¦å®ä¾‹æ˜¯ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå®ƒè¡¨ç¤ºæˆ‘ä»¬åœ¨åŒºå—é“¾ä¸Šçš„åˆçº¦ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä¸æˆ‘ä»¬çš„åˆçº¦è¿›è¡Œäº¤äº’ã€‚è¦å°†å…¶é™„åŠ åˆ°æˆ‘ä»¬éƒ¨ç½²çš„åˆçº¦ï¼Œæˆ‘ä»¬éœ€è¦æä¾›åˆçº¦åœ°å€ã€‚



```js
// Set up an ethers contract, representing our deployed Box instance
// è®¾ç½®ä¸€ä¸ª ethers åˆçº¦ï¼Œè¡¨ç¤ºæˆ‘ä»¬éƒ¨ç½²çš„ Box å®ä¾‹
const address = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
const Box = await ethers.getContractFactory('Box');
const box = Box.attach(address);
```

|      | ç¡®ä¿å°† `address` æ›¿æ¢ä¸ºä½ éƒ¨ç½²åˆçº¦æ—¶è·å¾—çš„åœ°å€ï¼Œè¯¥åœ°å€å¯èƒ½ä¸æ­¤å¤„æ˜¾ç¤ºçš„åœ°å€ä¸åŒã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨è¿™ä¸ª JavaScript å¯¹è±¡ä¸æˆ‘ä»¬çš„åˆçº¦è¿›è¡Œäº¤äº’ã€‚

### è°ƒç”¨åˆçº¦

è®©æˆ‘ä»¬ä»æ˜¾ç¤º `Box` åˆçº¦çš„å½“å‰å€¼å¼€å§‹ã€‚

æˆ‘ä»¬éœ€è¦è°ƒç”¨åˆçº¦çš„åªè¯» `retrieve()` å…¬å…±æ–¹æ³•ï¼Œå¹¶ [ç­‰å¾…](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await)å“åº”ï¼š



```js
// Call the retrieve() function of the deployed Box contract
// è°ƒç”¨å·²éƒ¨ç½²çš„ Box åˆçº¦çš„ retrieve() å‡½æ•°
const value = await box.retrieve();
console.log('Box value is', value.toString());
// Box å€¼ä¸º
```

æ­¤ä»£ç ç‰‡æ®µç­‰æ•ˆäºæˆ‘ä»¬ä¹‹å‰ä»æ§åˆ¶å°è¿è¡Œçš„ [æŸ¥è¯¢](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#querying-state)ã€‚ç°åœ¨ï¼Œé€šè¿‡å†æ¬¡è¿è¡Œè¯¥è„šæœ¬å¹¶æ£€æŸ¥æ‰“å°çš„å€¼æ¥ç¡®ä¿ä¸€åˆ‡è¿è¡Œé¡ºåˆ©ï¼š



```console
$ npx hardhat run --network localhost ./scripts/index.js
Box value is 42
// Box å€¼ä¸º 42
```

|      | å¦‚æœä½ åœ¨ä»»ä½•æ—¶å€™é‡æ–°å¯åŠ¨äº†æœ¬åœ°åŒºå—é“¾ï¼Œåˆ™æ­¤è„šæœ¬å¯èƒ½ä¼šå¤±è´¥ã€‚é‡æ–°å¯åŠ¨ä¼šæ¸…é™¤æ‰€æœ‰æœ¬åœ°åŒºå—é“¾çŠ¶æ€ï¼Œå› æ­¤ `Box` åˆçº¦å®ä¾‹å°†ä¸ä¼šä½äºé¢„æœŸçš„åœ°å€ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œåªéœ€ [å¯åŠ¨æœ¬åœ°åŒºå—é“¾](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#local-blockchain) å¹¶ [é‡æ–°éƒ¨ç½²](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#deploying-a-smart-contract) `Box` åˆçº¦ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

### å‘é€äº¤æ˜“

æˆ‘ä»¬ç°åœ¨å°†å‘é€ä¸€ä¸ªäº¤æ˜“æ¥ `store` ä¸€ä¸ªæ–°å€¼åˆ°æˆ‘ä»¬çš„ Box ä¸­ã€‚

è®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ `Box` ä¸­å­˜å‚¨ä¸€ä¸ª `23` çš„å€¼ï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„ä»£ç æ¥æ˜¾ç¤ºæ›´æ–°åçš„å€¼ï¼š



```js
// Send a transaction to store() a new value in the Box
// å‘é€ä¸€ä¸ªäº¤æ˜“ä»¥åœ¨ Box ä¸­ store() ä¸€ä¸ªæ–°å€¼
await box.store(23);

// Call the retrieve() function of the deployed Box contract
// è°ƒç”¨å·²éƒ¨ç½²çš„ Box åˆçº¦çš„ retrieve() å‡½æ•°
const value = await box.retrieve();
console.log('Box value is', value.toString());
// Box å€¼ä¸º
```

|      | åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½éœ€è¦ [ä¼°ç®—ä½ çš„äº¤æ˜“çš„ Gas](https://docs.ethers.org/v6/api/contract/#BaseContractMethod-estimateGas)ï¼Œå¹¶æ£€æŸ¥ [Gas ä»·æ ¼é¢„è¨€æœº](https://etherscan.io/gastracker)ä»¥äº†è§£åœ¨æ¯ä¸ªäº¤æ˜“ä¸­ä½¿ç”¨çš„æœ€ä½³å€¼ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æˆ‘ä»¬ç°åœ¨å¯ä»¥è¿è¡Œè¯¥ä»£ç ç‰‡æ®µï¼Œå¹¶æ£€æŸ¥ box çš„å€¼æ˜¯å¦å·²æ›´æ–°ï¼



```console
$ npx hardhat run --network localhost ./scripts/index.js
Box value is 23
// Box å€¼ä¸º 23
```

## åç»­æ­¥éª¤



# ç¼–å†™è‡ªåŠ¨åŒ–æ™ºèƒ½åˆçº¦æµ‹è¯•

åœ¨åŒºå—é“¾ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªç®€å•çš„é”™è¯¯å¯èƒ½ä¼šè®©ä½ æŸå¤±æ‰€æœ‰çš„èµ„é‡‘ - ç”šè‡³æ›´ç³Ÿï¼ŒæŸå¤±ä½ ç”¨æˆ·çš„èµ„é‡‘ï¼æœ¬æŒ‡å—å°†å¸®åŠ©ä½ é€šè¿‡ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•æ¥å¼€å‘å¥å£®çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›æµ‹è¯•å¯ä»¥éªŒè¯ä½ çš„åº”ç”¨ç¨‹åºæ˜¯å¦å®Œå…¨æŒ‰ç…§ä½ é¢„æœŸçš„æ–¹å¼è¿è¡Œã€‚

æˆ‘ä»¬å°†ä»‹ç»ä»¥ä¸‹ä¸»é¢˜ï¼š

- [è®¾ç½®æµ‹è¯•ç¯å¢ƒ](https://learnblockchain.cn/docs/openzeppelin/learn/writing-automated-tests.html#setting-up-a-testing-environment)
- [ç¼–å†™å•å…ƒæµ‹è¯•](https://learnblockchain.cn/docs/openzeppelin/learn/writing-automated-tests.html#writing-unit-tests)
- [æ‰§è¡Œå¤æ‚æ–­è¨€](https://learnblockchain.cn/docs/openzeppelin/learn/writing-automated-tests.html#performing-complex-assertions)

## å…³äºæµ‹è¯•

æµ‹è¯•æŠ€æœ¯æœ‰å¾ˆå¤šç§ï¼Œä» [ç®€å•çš„æ‰‹åŠ¨éªŒè¯](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#interacting-from-the-console)åˆ°å¤æ‚çš„ç«¯åˆ°ç«¯è®¾ç½®ï¼Œå®ƒä»¬å„è‡ªéƒ½æœ‰ç”¨å¤„ã€‚

ç„¶è€Œï¼Œè¯´åˆ°æ™ºèƒ½åˆçº¦å¼€å‘ï¼Œå®è·µè¡¨æ˜åˆçº¦ [*å•å…ƒæµ‹è¯•*](https://en.wikipedia.org/wiki/Unit_testing) å¼‚å¸¸æœ‰ä»·å€¼ã€‚è¿™äº›æµ‹è¯•ç¼–å†™ç®€å•ï¼Œè¿è¡Œå¿«é€Ÿï¼Œè®©ä½ èƒ½å¤Ÿè‡ªä¿¡åœ°æ·»åŠ åŠŸèƒ½å’Œä¿®å¤ä»£ç ä¸­çš„é”™è¯¯ã€‚

æ™ºèƒ½åˆçº¦å•å…ƒæµ‹è¯•ç”±å¤šä¸ªå°å‹ã€é›†ä¸­çš„æµ‹è¯•ç»„æˆï¼Œæ¯ä¸ªæµ‹è¯•éƒ½æ£€æŸ¥åˆçº¦çš„ä¸€å°éƒ¨åˆ†æ˜¯å¦æ­£ç¡®ã€‚å®ƒä»¬é€šå¸¸å¯ä»¥ç”¨æ„æˆè§„èŒƒçš„å•ä¸ªå¥å­æ¥è¡¨è¾¾ï¼Œä¾‹å¦‚â€œç®¡ç†å‘˜èƒ½å¤Ÿæš‚åœåˆçº¦â€ã€â€œè½¬ç§» tokens ä¼šå‘å‡ºäº‹ä»¶â€æˆ–â€œéç®¡ç†å‘˜ä¸èƒ½é“¸é€ æ–°çš„ tokensâ€ã€‚

## è®¾ç½®æµ‹è¯•ç¯å¢ƒ

ä½ å¯èƒ½æƒ³çŸ¥é“æˆ‘ä»¬_å¦‚ä½•_è¿è¡Œè¿™äº›æµ‹è¯•ï¼Œå› ä¸ºæ™ºèƒ½åˆçº¦æ˜¯åœ¨åŒºå—é“¾å†…éƒ¨æ‰§è¡Œçš„ã€‚ä½¿ç”¨å®é™…çš„ Ethereum ç½‘ç»œä¼šéå¸¸æ˜‚è´µï¼Œè™½ç„¶æµ‹è¯•ç½‘æ˜¯å…è´¹çš„ï¼Œä½†å®ƒä»¬ä¹Ÿå¾ˆæ…¢ï¼ˆåŒºå—æ—¶é—´ä¸º 12 ç§’æˆ–æ›´é•¿ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ‰“ç®—åœ¨æ¯æ¬¡æ›´æ”¹ä»£ç æ—¶è¿è¡Œæ•°ç™¾ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¥½çš„ä¸œè¥¿ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§å«åš_æœ¬åœ°åŒºå—é“¾_çš„ä¸œè¥¿ï¼šå®ƒæ˜¯çœŸå®åŒºå—é“¾çš„ç²¾ç®€ç‰ˆæœ¬ï¼Œä¸äº’è”ç½‘æ–­å¼€è¿æ¥ï¼Œåœ¨ä½ çš„æœºå™¨ä¸Šè¿è¡Œã€‚è¿™å°†å¤§å¤§ç®€åŒ–äº‹æƒ…ï¼šä½ ä¸éœ€è¦è·å¾— Etherï¼Œå¹¶ä¸”ä¼šç«‹å³æŒ–æ˜å‡ºæ–°çš„åŒºå—ã€‚

## ç¼–å†™å•å…ƒæµ‹è¯•

æˆ‘ä»¬å°†ä½¿ç”¨ [Chai](https://www.chaijs.com/) æ–­è¨€è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡å®‰è£… Hardhat Toolbox æ¥ä½¿ç”¨ã€‚



```console
$ npm install --save-dev @nomicfoundation/hardhat-toolbox
```

æˆ‘ä»¬å°†æŠŠæµ‹è¯•æ–‡ä»¶ä¿å­˜åœ¨ `test` ç›®å½•ä¸­ã€‚æœ€å¥½é€šè¿‡é•œåƒ [`contracts` ç›®å½•](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#first-contract)æ¥æ„å»ºæµ‹è¯•ï¼šå¯¹äºé‚£é‡Œçš„æ¯ä¸ª `.sol` æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç›¸åº”çš„æµ‹è¯•æ–‡ä»¶ã€‚

æ˜¯æ—¶å€™ç¼–å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•äº†ï¼è¿™äº›æµ‹è¯•å°†æµ‹è¯• `Box` åˆçº¦çš„å±æ€§ [æ¥è‡ªä¹‹å‰çš„æŒ‡å—](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#box-contract)ï¼šä¸€ä¸ªç®€å•çš„åˆçº¦ï¼Œå…è®¸ä½  `retrieve` æ‰€æœ‰è€…ä¹‹å‰ `store` çš„å€¼ã€‚

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `test` ç›®å½•ã€‚æˆ‘ä»¬å°†æŠŠæµ‹è¯•ä¿å­˜ä¸º `test/Box.test.js`ã€‚æ¯ä¸ªæµ‹è¯• `.js` æ–‡ä»¶é€šå¸¸åŒ…å«å•ä¸ªåˆçº¦çš„æµ‹è¯•ï¼Œå¹¶ä»¥è¯¥åˆçº¦å‘½åã€‚



```js
// test/Box.test.js
// Load dependencies
const { expect } = require('chai');

// Start test block
describe('Box', function () {
  before(async function () {
    this.Box = await ethers.getContractFactory('Box');
  });

  beforeEach(async function () {
    this.box = await this.Box.deploy();
    await this.box.waitForDeployment();
  });

  // Test case
  it('retrieve returns a value previously stored', async function () {
    // Store a value
    await this.box.store(42);

    // Test if the returned value is the same one
    // Note that we need to use strings to compare the 256 bit integers
    expect((await this.box.retrieve()).toString()).to.equal('42');
  });
});
```

|      | å·²ç»æœ‰å¾ˆå¤šå…³äºå¦‚ä½•æ„å»ºå•å…ƒæµ‹è¯•çš„ä¹¦ç±ã€‚æŸ¥çœ‹ [Moloch Testing Guide](https://github.com/MolochVentures/moloch/tree/4e786db8a4aa3158287e0935dcbc7b1e43416e38/test#moloch-testing-guide)ï¼Œäº†è§£ä¸€å¥—ä¸“ä¸ºæµ‹è¯• Solidity æ™ºèƒ½åˆçº¦è€Œè®¾è®¡çš„åŸåˆ™ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æˆ‘ä»¬ç°åœ¨å‡†å¤‡å¥½è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•äº†ï¼

è¿è¡Œ `npx hardhat test` å°†æ‰§è¡Œ `test` ç›®å½•ä¸­çš„æ‰€æœ‰æµ‹è¯•ï¼Œæ£€æŸ¥ä½ çš„åˆçº¦æ˜¯å¦ä»¥ä½ å¸Œæœ›çš„æ–¹å¼å·¥ä½œï¼š



```console
$ npx hardhat test


  Box
    âœ“ retrieve returns a value previously stored


  1 passing (578ms)
```

æ­¤æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæŒç»­é›†æˆæœåŠ¡ï¼ˆä¾‹å¦‚ [CircleCI](https://circleci.com/)ï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸»æ„ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡å°†ä»£ç æäº¤åˆ° GitHub æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•ã€‚

## æ‰§è¡Œå¤æ‚æ–­è¨€

ä½ çš„åˆçº¦çš„è®¸å¤šæœ‰è¶£çš„å±æ€§å¯èƒ½éš¾ä»¥æ•è·ï¼Œä¾‹å¦‚ï¼š

- éªŒè¯åˆçº¦æ˜¯å¦åœ¨é”™è¯¯æ—¶æ¢å¤
- æµ‹é‡å¸æˆ·çš„ Ether ä½™é¢å˜åŒ–äº†å¤šå°‘
- æ£€æŸ¥æ˜¯å¦å‘å‡ºäº†æ­£ç¡®çš„äº‹ä»¶

æˆ‘ä»¬å»ºè®®ä½¿ç”¨ [Hardhat Chai Matchers](https://hardhat.org/hardhat-chai-matchers/docs/overview) æ¥å¸®åŠ©ä½ æµ‹è¯•æ‰€æœ‰è¿™äº›å±æ€§ï¼Œå¹¶ä½¿ç”¨ [Hardhat Network Helpers](https://hardhat.org/hardhat-network-helpers/docs/overview) æ¥æ¨¡æ‹ŸåŒºå—é“¾ä¸Šçš„æ—¶é—´æµé€ã€‚è¿™äº›å·¥å…·å°†è®©ä½ ç¼–å†™å¼ºå¤§çš„æ–­è¨€ï¼Œè€Œæ— éœ€æ‹…å¿ƒåº•å±‚ Ethereum åº“çš„åº•å±‚ç»†èŠ‚ã€‚

## ä¸‹ä¸€æ­¥



# è¿æ¥åˆ°å…¬å…±æµ‹è¯•ç½‘ç»œ

åœ¨æ‚¨ [ç¼–å†™äº†æ‚¨çš„åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html)ã€[åœ¨æœ¬åœ°å°è¯•è¿‡å®ƒä»¬](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html) å’Œ [å½»åº•æµ‹è¯•è¿‡å®ƒä»¬](https://learnblockchain.cn/docs/openzeppelin/learn/writing-automated-tests.html) ä¹‹åï¼Œå°±è¯¥è½¬ç§»åˆ°ä¸€ä¸ªæŒä¹…çš„å…¬å…±æµ‹è¯•ç¯å¢ƒäº†ï¼Œæ‚¨å’Œæ‚¨çš„ beta ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œå¼€å§‹ä¸æ‚¨çš„åº”ç”¨ç¨‹åºäº¤äº’ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨*å…¬å…±æµ‹è¯•ç½‘ç»œ*ï¼ˆä¹Ÿç§°ä¸º *testnets*ï¼‰ï¼Œè¿™äº›ç½‘ç»œä¸ä»¥å¤ªåŠä¸»ç½‘ç»œç±»ä¼¼ï¼Œä½†å…¶ä¸­çš„ Ether æ²¡æœ‰ä»·å€¼å¹¶ä¸”å¯ä»¥å…è´¹è·å¾— - è¿™ä½¿å¾—å®ƒä»¬æˆä¸ºé›¶æˆæœ¬æµ‹è¯•åˆçº¦çš„ç†æƒ³é€‰æ‹©ã€‚

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬æœ€å–œæ¬¢çš„ [`Box` åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#box-contract)ï¼Œå¹¶å°†å…¶éƒ¨ç½²åˆ°æµ‹è¯•ç½‘ï¼ŒåŒæ—¶å­¦ä¹ ï¼š

- [æœ‰å“ªäº›å¯ç”¨çš„æµ‹è¯•ç½‘ç»œ](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#testnet-list)
- [å¦‚ä½•è®¾ç½®æ‚¨çš„é¡¹ç›®ä»¥åœ¨æµ‹è¯•ç½‘ä¸Šå·¥ä½œ](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#connecting-project-to-network)
- [å¦‚ä½•éƒ¨ç½²æµ‹è¯•ç½‘åˆçº¦å®ä¾‹å¹¶ä¸ä¹‹äº¤äº’](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#working-on-testnet)

è¯·è®°ä½ï¼Œéƒ¨ç½²åˆ°å…¬å…±æµ‹è¯•ç½‘ç»œæ˜¯å¼€å‘ Ethereum é¡¹ç›®çš„å¿…è¦æ­¥éª¤ã€‚å®ƒä»¬æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æµ‹è¯•ç¯å¢ƒï¼Œå¯ä»¥å¯†åˆ‡æ¨¡æ‹Ÿä¸»ç½‘ç»œ - æ‚¨ä¸å¸Œæœ›åœ¨é”™è¯¯ä¼šèŠ±è´¹æ‚¨å’Œæ‚¨çš„ç”¨æˆ·é‡‘é’±çš„ç½‘ç»œä¸­è¿›è¡Œé¡¹ç›®è¯•è¿è¡Œï¼

## å¯ç”¨çš„æµ‹è¯•ç½‘ç»œ

æœ‰è®¸å¤šæµ‹è¯•ç½‘ç»œå¯ä¾›é€‰æ‹©ï¼Œæ¯ä¸ªç½‘ç»œéƒ½æœ‰è‡ªå·±çš„ç‰¹ç‚¹ã€‚ å»ºè®®ç”¨äºæµ‹è¯•å»ä¸­å¿ƒåŒ–åº”ç”¨ç¨‹åºå’Œæ™ºèƒ½åˆçº¦çš„ç½‘ç»œæ˜¯ Sepoliaã€‚(id=11155111)

|      | æ¯ä¸ªç½‘ç»œéƒ½ç”±ä¸€ä¸ªæ•°å­— ID æ ‡è¯†ã€‚ æœ¬åœ°ç½‘ç»œé€šå¸¸å…·æœ‰è¾ƒå¤§çš„éšæœºå€¼ï¼Œè€Œ id=1 ä¿ç•™ç»™ Ethereum ä¸»ç½‘ç»œã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## å°†é¡¹ç›®è¿æ¥åˆ°å…¬å…±ç½‘ç»œ

è¦å°†æˆ‘ä»¬çš„é¡¹ç›®è¿æ¥åˆ°å…¬å…±æµ‹è¯•ç½‘ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. [è·å–æµ‹è¯•ç½‘èŠ‚ç‚¹](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#accessing-a-testnet-node)
2. [åˆ›å»ºä¸€ä¸ªæ–°å¸æˆ·](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#creating-a-new-account)
3. [æ›´æ–°æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#configuring-the-network)
4. [ä¸ºæˆ‘ä»¬çš„æµ‹è¯•å¸æˆ·å……å€¼](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html#finding-a-testnet-account)

### è®¿é—®æµ‹è¯•ç½‘èŠ‚ç‚¹

è™½ç„¶æ‚¨å¯ä»¥å¯åŠ¨æ‚¨è‡ªå·±çš„ [Ethereum èŠ‚ç‚¹](https://ethereum.org/en/developers/docs/nodes-and-clients/run-a-node/) è¿æ¥åˆ°æµ‹è¯•ç½‘ï¼Œä½†è®¿é—®æµ‹è¯•ç½‘çš„æœ€ç®€å•æ–¹æ³•æ˜¯é€šè¿‡å…¬å…±èŠ‚ç‚¹æœåŠ¡ï¼Œä¾‹å¦‚ [Alchemy](https://alchemy.com/) æˆ– [Infura](https://infura.io/)ã€‚ Alchemy å’Œ Infura é€šè¿‡å…è´¹å’Œä»˜è´¹è®¡åˆ’æä¾›å¯¹æ‰€æœ‰æµ‹è¯•ç½‘å’Œä¸»ç½‘ç»œçš„å…¬å…±èŠ‚ç‚¹çš„è®¿é—®ã€‚

|      | å½“ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥è¢«å…¬ä¼—è®¿é—®å¹¶ä¸”ä¸ç®¡ç†ä»»ä½•å¸æˆ·æ—¶ï¼Œæˆ‘ä»¬è¯´è¯¥èŠ‚ç‚¹æ˜¯_å…¬å…±çš„_ã€‚ è¿™æ„å‘³ç€å®ƒå¯ä»¥å›å¤æŸ¥è¯¢å¹¶ä¸­ç»§ç­¾åäº¤æ˜“ï¼Œä½†ä¸èƒ½è‡ªè¡Œç­¾ç½²äº¤æ˜“ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Alchemyï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ [Infura](https://infura.io/) æˆ–æ‚¨é€‰æ‹©çš„å…¶ä»–å…¬å…±èŠ‚ç‚¹æä¾›å•†ã€‚

å‰å¾€ [Alchemy](https://dashboard.alchemyapi.io/signup?referral=53fcee38-b894-4d5f-bd65-885d241f8d29)ï¼ˆåŒ…æ‹¬æ¨èä»£ç ï¼‰ï¼Œæ³¨å†Œå¹¶è®°ä¸‹æ‚¨åˆ†é…çš„ API å¯†é’¥ - æˆ‘ä»¬ç¨åå°†ä½¿ç”¨å®ƒè¿æ¥åˆ°ç½‘ç»œã€‚

### åˆ›å»ºä¸€ä¸ªæ–°å¸æˆ·

è¦åœ¨æµ‹è¯•ç½‘ä¸­å‘é€äº¤æ˜“ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæ–°çš„ Ethereum å¸æˆ·ã€‚ æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼šè¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ `mnemonics` åŒ…ï¼Œå®ƒå°†è¾“å‡ºä¸€ä¸ªæ–°çš„åŠ©è®°è¯ï¼ˆä¸€ç»„ 12 ä¸ªå•è¯ï¼‰ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥æ´¾ç”Ÿæˆ‘ä»¬çš„å¸æˆ·ï¼š



```console
$ npx mnemonics
drama film snack motion ...
```

|      | è¯·åŠ¡å¿…ä¿æŠ¤å¥½æ‚¨çš„åŠ©è®°è¯ã€‚ ä¸è¦å°†å¯†ç æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚ å³ä½¿åªæ˜¯ä¸ºäº†æµ‹è¯•ç›®çš„ï¼Œä»ç„¶ä¼šæœ‰æ¶æ„ç”¨æˆ·ä¸ºäº†å¥½ç©è€Œç ´åæ‚¨çš„æµ‹è¯•ç½‘éƒ¨ç½²ï¼ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

### é…ç½®ç½‘ç»œ

ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å…¬å…±èŠ‚ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°ç­¾ç½²æ‰€æœ‰äº¤æ˜“ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬çš„åŠ©è®°è¯å’Œ Alchemy ç«¯ç‚¹é…ç½®ç½‘ç»œã€‚

|      | è¿™éƒ¨åˆ†å‡è®¾æ‚¨å·²ç»è®¾ç½®äº†ä¸€ä¸ªé¡¹ç›®ã€‚ å¦‚æœæ‚¨è¿˜æ²¡æœ‰ï¼Œè¯·å‰å¾€ [è®¾ç½® Solidity é¡¹ç›®](https://learnblockchain.cn/docs/openzeppelin/learn/developing-smart-contracts.html#setting-up-a-solidity-project)æŒ‡å—ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸æµ‹è¯•ç½‘çš„æ–°ç½‘ç»œè¿æ¥æ›´æ–°æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ã€‚ è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ Sepoliaï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨æ‚¨æƒ³è¦çš„ä»»ä½•ä¸€ä¸ªï¼š



```diff
// hardhat.config.js
+ const { alchemyApiKey, mnemonic } = require('./secrets.json');
...
  module.exports = {
+    networks: {
+     sepolia: {
+       url: `https://eth-sepolia.g.alchemy.com/v2/${alchemyApiKey}`,
+       accounts: { mnemonic: mnemonic },
+     },
+   },
...
};
```

|      | æœ‰å…³é…ç½®é€‰é¡¹çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… Hardhat [ç½‘ç»œé…ç½®](https://hardhat.org/config/#json-rpc-based-networks)æ–‡æ¡£ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

è¯·æ³¨æ„ï¼Œåœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ä» `secrets.json` æ–‡ä»¶ä¸­åŠ è½½é¡¹ç›® ID å’ŒåŠ©è®°è¯ï¼Œè¯¥æ–‡ä»¶åº”å¦‚ä¸‹æ‰€ç¤ºï¼Œä½†ä½¿ç”¨æ‚¨è‡ªå·±çš„å€¼ã€‚ ç¡®ä¿å¯¹å…¶è¿›è¡Œ `.gitignore`ï¼Œä»¥ç¡®ä¿æ‚¨ä¸ä¼šå°†å¯†ç æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼



```json
{
  "mnemonic": "drama film snack motion ...",
  "alchemyApiKey": "JPV2..."
}
```

|      | é™¤äº† `secrets.json` æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨å–œæ¬¢çš„ä»»ä½•å¯†ç ç®¡ç†è§£å†³æ–¹æ¡ˆæ¥ç®¡ç†æ‚¨çš„é¡¹ç›®ã€‚ ä¸€ä¸ªæµè¡Œä¸”ç®€å•çš„é€‰æ‹©æ˜¯ä½¿ç”¨ [`dotenv`](https://github.com/motdotla/dotenv) å°†å¯†ç ä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡åˆ—å‡ºæˆ‘ä»¬å¯ç”¨äº Sepolia ç½‘ç»œçš„å¸æˆ·æ¥æµ‹è¯•æ­¤é…ç½®æ˜¯å¦æœ‰æ•ˆã€‚ è¯·è®°ä½ï¼Œæ‚¨çš„å¸æˆ·ä¼šæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºå®ƒä»¬å–å†³äºæ‚¨ä½¿ç”¨çš„åŠ©è®°è¯ã€‚



```console
$ npx hardhat console --network sepolia
Welcome to Node.js v20.17.0.
Type ".help" for more information.
> accounts = (await ethers.getSigners()).map(signer => signer.address)
[
  '0x6B1c3A2f2160a7Cb2ebc7Fc861b8dB71476C30E7',
  '0xC1310ade58A75E6d4fCb8238f9559188Ea3808f9',
...
]
```

æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŸ¥è¯¢æˆ‘ä»¬çš„å¸æˆ·ä½™é¢æ¥æµ‹è¯•ä¸èŠ‚ç‚¹çš„è¿æ¥ã€‚



```console
> (await ethers.provider.getBalance(accounts[0])).toString()
'0'
```

ç©ºç©ºå¦‚ä¹Ÿï¼ è¿™æŒ‡å‘æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼šè·å–æµ‹è¯•ç½‘èµ„é‡‘ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å‘é€äº¤æ˜“ã€‚

### ä¸ºæµ‹è¯•ç½‘å¸æˆ·å……å€¼

å¤§å¤šæ•°å…¬å…±æµ‹è¯•ç½‘éƒ½æœ‰ä¸€ä¸ªæ°´é¾™å¤´ï¼šä¸€ä¸ªå¯ä»¥å…è´¹ä¸ºæ‚¨æä¾›å°‘é‡æµ‹è¯• Ether çš„ç½‘ç«™ã€‚ å¦‚æœæ‚¨åœ¨ Sepolia ä¸Šï¼Œè¯·å‰å¾€ [Alchemy çš„å…è´¹ Sepolia æ°´é¾™å¤´](https://www.alchemy.com/faucets/ethereum-sepolia)ã€https://www.infura.io/faucet[Infura çš„å…è´¹ Sepolia æ°´é¾™å¤´] æˆ– [Google çš„å…è´¹ Sepolia æ°´é¾™å¤´](https://cloud.google.com/application/web3/faucet/ethereum/sepolia) ä»¥è·å–å…è´¹çš„ testETHã€‚

æœ‰äº†èµ„é‡‘å……è¶³çš„å¸æˆ·ï¼Œè®©æˆ‘ä»¬å°†æˆ‘ä»¬çš„åˆçº¦éƒ¨ç½²åˆ°æµ‹è¯•ç½‘ï¼

## åœ¨æµ‹è¯•ç½‘ä¸Šå·¥ä½œ

é€šè¿‡é…ç½®ä¸ºåœ¨å…¬å…±æµ‹è¯•ç½‘ä¸Šå·¥ä½œçš„é¡¹ç›®ï¼Œæˆ‘ä»¬ç°åœ¨ç»ˆäºå¯ä»¥ [éƒ¨ç½²æˆ‘ä»¬çš„ `Box` åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#deploying-a-smart-contract)äº†ã€‚ æ­¤å¤„çš„å‘½ä»¤ä¸æ‚¨åœ¨ [æœ¬åœ°å¼€å‘ç½‘ç»œ](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#local-blockchain)ä¸Šå®Œå…¨ç›¸åŒï¼Œå°½ç®¡ç”±äºéœ€è¦æŒ–æ˜æ–°åŒºå—ï¼Œå› æ­¤éœ€è¦å‡ ç§’é’Ÿæ‰èƒ½è¿è¡Œã€‚



```console
$ npx hardhat run --network sepolia scripts/deploy.js
Deploying Box...
Box deployed to: 0x1b99CCaCea0e4046db618770dEF72180F8138641
```

å°±è¿™æ ·ï¼ æ‚¨çš„ `Box` åˆçº¦å®ä¾‹å°†æ°¸è¿œå­˜å‚¨åœ¨æµ‹è¯•ç½‘ä¸­ï¼Œå¹¶ä¸”å¯¹ä»»ä½•äººå…¬å¼€ã€‚

æ‚¨å¯ä»¥åœ¨åŒºå—æµè§ˆå™¨ï¼ˆä¾‹å¦‚ [Etherscan](https://etherscan.io/)ï¼‰ä¸ŠæŸ¥çœ‹æ‚¨çš„åˆçº¦ã€‚ è¯·è®°ä½è®¿é—®æ‚¨éƒ¨ç½²åˆçº¦çš„æµ‹è¯•ç½‘ä¸Šçš„æµè§ˆå™¨ï¼Œä¾‹å¦‚ Sepolia çš„ [sepolia.etherscan.io](https://sepolia.etherscan.io/)ã€‚

|      | æ‚¨å¯ä»¥åœ¨ [æ­¤å¤„](https://sepolia.etherscan.io/address/0x1b99CCaCea0e4046db618770dEF72180F8138641)æŸ¥çœ‹æˆ‘ä»¬åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­éƒ¨ç½²çš„åˆçº¦ä»¥åŠå‘é€ç»™å®ƒçš„æ‰€æœ‰äº¤æ˜“ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æ‚¨è¿˜å¯ä»¥åƒå¾€å¸¸ä¸€æ ·ä¸å®ä¾‹äº¤äº’ï¼Œå¯ä»¥ä½¿ç”¨ [æ§åˆ¶å°](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#interacting-from-the-console)æˆ– [ä»¥ç¼–ç¨‹æ–¹å¼](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#interacting-programatically)ã€‚



```console
$ npx hardhat console --network sepolia
Welcome to Node.js v20.17.0.
Type ".help" for more information.
> const Box = await ethers.getContractFactory('Box');
undefined
> const box = await Box.attach('0x1b99CCaCea0e4046db618770dEF72180F8138641');
undefined
> await box.store(42);
{
  hash: '0x330e331d30ee83f96552d82b7fdfa6156f9f97d549a612eeef7283d18b31d107',
...
> (await box.retrieve()).toString()
'42'
```

è¯·è®°ä½ï¼Œæ¯æ¬¡äº¤æ˜“éƒ½ä¼šèŠ±è´¹ä¸€äº› Gasï¼Œå› æ­¤æ‚¨æœ€ç»ˆéœ€è¦ç”¨æ›´å¤šèµ„é‡‘æ¥è¡¥å……æ‚¨çš„å¸æˆ·ã€‚

## åç»­æ­¥éª¤



# å‡çº§æ™ºèƒ½åˆçº¦

ä½¿ç”¨ [OpenZeppelin Upgrades Plugins](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/) éƒ¨ç½²çš„æ™ºèƒ½åˆçº¦å¯ä»¥è¢«**å‡çº§**ä»¥ä¿®æ”¹å…¶ä»£ç ï¼ŒåŒæ—¶ä¿ç•™å…¶åœ°å€ã€çŠ¶æ€å’Œä½™é¢ã€‚è¿™å…è®¸æ‚¨è¿­ä»£åœ°å‘æ‚¨çš„é¡¹ç›®æ·»åŠ æ–°åŠŸèƒ½ï¼Œæˆ–è€…ä¿®å¤æ‚¨åœ¨ [ç”Ÿäº§ç¯å¢ƒ](https://learnblockchain.cn/docs/openzeppelin/learn/preparing-for-mainnet.html) ä¸­å¯èƒ½å‘ç°çš„ä»»ä½•é”™è¯¯ã€‚

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- [ä¸ºä»€ä¹ˆå‡çº§å¾ˆé‡è¦](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html#whats-in-an-upgrade)
- [ä½¿ç”¨ Upgrades Plugins å‡çº§æˆ‘ä»¬çš„ Box](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html#upgrading-a-contract-via-plugins)
- [äº†è§£å‡çº§çš„åº•å±‚å·¥ä½œåŸç†](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html#how-upgrades-work)
- [å­¦ä¹ å¦‚ä½•ç¼–å†™å¯å‡çº§çš„åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html#limitations-of-contract-upgrades)

## å‡çº§çš„æ„ä¹‰

Ethereum ä¸­çš„æ™ºèƒ½åˆçº¦é»˜è®¤æ˜¯ä¸å¯å˜çš„ã€‚ä¸€æ—¦æ‚¨åˆ›å»ºäº†å®ƒä»¬ï¼Œå°±æ²¡æœ‰åŠæ³•æ›´æ”¹å®ƒä»¬ï¼Œå®é™…ä¸Šå……å½“å‚ä¸è€…ä¹‹é—´ä¸å¯ç ´åçš„åˆçº¦ã€‚

ç„¶è€Œï¼Œå¯¹äºæŸäº›åœºæ™¯ï¼Œèƒ½å¤Ÿä¿®æ”¹å®ƒä»¬æ˜¯å¯å–çš„ã€‚æƒ³è±¡ä¸€ä¸‹åŒæ–¹ä¹‹é—´çš„ä¼ ç»ŸåˆåŒï¼šå¦‚æœä»–ä»¬éƒ½åŒæ„æ›´æ”¹å®ƒï¼Œä»–ä»¬å°±å¯ä»¥è¿™æ ·åšã€‚åœ¨ Ethereum ä¸Šï¼Œä»–ä»¬å¯èƒ½å¸Œæœ›æ›´æ”¹æ™ºèƒ½åˆçº¦ä»¥ä¿®å¤ä»–ä»¬å‘ç°çš„é”™è¯¯ï¼ˆè¿™ç”šè‡³å¯èƒ½å¯¼è‡´é»‘å®¢çªƒå–ä»–ä»¬çš„èµ„é‡‘ï¼ï¼‰ï¼Œæ·»åŠ å…¶ä»–åŠŸèƒ½ï¼Œæˆ–è€…åªæ˜¯æ›´æ”¹å®ƒæ‰€æ‰§è¡Œçš„è§„åˆ™ã€‚

ä»¥ä¸‹æ˜¯ä¿®å¤æ‚¨æ— æ³•å‡çº§çš„åˆçº¦ä¸­çš„é”™è¯¯æ‰€éœ€æ‰§è¡Œçš„æ“ä½œï¼š

1. éƒ¨ç½²åˆçº¦çš„æ–°ç‰ˆæœ¬
2. æ‰‹åŠ¨å°†æ‰€æœ‰çŠ¶æ€ä»æ—§åˆçº¦è¿ç§»åˆ°æ–°åˆçº¦ï¼ˆè¿™åœ¨ Gas è´¹ç”¨æ–¹é¢å¯èƒ½éå¸¸æ˜‚è´µï¼ï¼‰
3. æ›´æ–°æ‰€æœ‰ä¸æ—§åˆçº¦äº¤äº’çš„åˆçº¦ä»¥ä½¿ç”¨æ–°åˆçº¦çš„åœ°å€
4. è”ç³»æ‚¨çš„æ‰€æœ‰ç”¨æˆ·å¹¶è¯´æœä»–ä»¬å¼€å§‹ä½¿ç”¨æ–°çš„éƒ¨ç½²ï¼ˆå¹¶å¤„ç†åŒæ—¶ä½¿ç”¨çš„ä¸¤ä¸ªåˆçº¦ï¼Œå› ä¸ºç”¨æˆ·è¿ç§»é€Ÿåº¦å¾ˆæ…¢ï¼‰

ä¸ºäº†é¿å…ç»å†è¿™ç§æ··ä¹±ï¼Œæˆ‘ä»¬å°†åˆçº¦å‡çº§ç›´æ¥æ„å»ºåˆ°æˆ‘ä»¬çš„æ’ä»¶ä¸­ã€‚è¿™ä½¿æˆ‘ä»¬å¯ä»¥*æ›´æ”¹åˆçº¦ä»£ç ï¼ŒåŒæ—¶ä¿ç•™çŠ¶æ€ã€ä½™é¢å’Œåœ°å€*ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®é™…æ•ˆæœã€‚

## ä½¿ç”¨ Upgrades Plugins è¿›è¡Œå‡çº§

æ¯å½“æ‚¨åœ¨ [OpenZeppelin Upgrades Plugins](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/) ä¸­ä½¿ç”¨ `deployProxy` éƒ¨ç½²æ–°åˆçº¦æ—¶ï¼Œè¯¥åˆçº¦å®ä¾‹ä»¥åéƒ½å¯ä»¥**å‡çº§**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰æœ€åˆéƒ¨ç½²åˆçº¦çš„åœ°å€æ‰æœ‰æƒå‡çº§å®ƒã€‚

`deployProxy` å°†åˆ›å»ºä»¥ä¸‹äº¤æ˜“ï¼š

1. éƒ¨ç½²å®ç°åˆçº¦ï¼ˆæˆ‘ä»¬çš„ `Box` åˆçº¦ï¼‰
2. éƒ¨ç½²ä»£ç†åˆçº¦å¹¶è¿è¡Œä»»ä½•åˆå§‹åŒ–å‡½æ•°ã€‚
   - åœ¨ä¸‹é¢çš„åœºæ™¯ä¸­ï¼Œä»£ç†éƒ¨ç½²ä¼šè‡ªåŠ¨éƒ¨ç½²ä¸€ä¸ª `ProxyAdmin` åˆçº¦ï¼ˆæˆ‘ä»¬ä»£ç†çš„ç®¡ç†ï¼‰ã€‚

è®©æˆ‘ä»¬é€šè¿‡éƒ¨ç½²ä¸€ä¸ªå¯å‡çº§ç‰ˆæœ¬çš„ `Box` åˆçº¦æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½¿ç”¨ä¸ [æˆ‘ä»¬ä¹‹å‰éƒ¨ç½²æ—¶](https://learnblockchain.cn/docs/openzeppelin/learn/deploying-and-interacting.html#deploying-a-smart-contract)ç›¸åŒçš„è®¾ç½®ï¼š



```solidity
// contracts/Box.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Box {
    uint256 private _value;

    // Emitted when the stored value changes
    // å½“å­˜å‚¨çš„å€¼å‘ç”Ÿæ›´æ”¹æ—¶å‘å‡º
    event ValueChanged(uint256 value);

    // Stores a new value in the contract
    // åœ¨åˆçº¦ä¸­å­˜å‚¨ä¸€ä¸ªæ–°å€¼
    function store(uint256 value) public {
        _value = value;
        emit ValueChanged(value);
    }

    // Reads the last stored value
    // è¯»å–æœ€åå­˜å‚¨çš„å€¼
    function retrieve() public view returns (uint256) {
        return _value;
    }
}
```

æˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£… Upgrades Pluginã€‚

å®‰è£… [Hardhat Upgrades](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/hardhat-upgrades) æ’ä»¶ã€‚



```bash
npm install --save-dev @openzeppelin/hardhat-upgrades
```

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Hardhat ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ `@openzeppelin/hardhat-upgrades` æ’ä»¶ã€‚ä¸ºæ­¤ï¼Œè¯·åœ¨æ‚¨çš„ `hardhat.config.js` æ–‡ä»¶ä¸­æ·»åŠ è¯¥æ’ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚



```js
// hardhat.config.js
...
require("@nomicfoundation/hardhat-ethers");
require('@openzeppelin/hardhat-upgrades');
...
module.exports = {
...
};
```

ä¸ºäº†å‡çº§åƒ `Box` è¿™æ ·çš„åˆçº¦ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆå°†å…¶éƒ¨ç½²ä¸ºå¯å‡çº§åˆçº¦ï¼Œè¿™ä¸æˆ‘ä»¬ç›®å‰æ‰€è§çš„éƒ¨ç½²è¿‡ç¨‹ä¸åŒã€‚æˆ‘ä»¬å°†é€šè¿‡è°ƒç”¨ `store` å¹¶èµ‹å€¼ä¸º 42 æ¥åˆå§‹åŒ–æˆ‘ä»¬çš„ Box åˆçº¦ã€‚

ä½¿ç”¨ Hardhatï¼Œæˆ‘ä»¬ä½¿ç”¨ [è„šæœ¬](https://hardhat.org/hardhat-runner/docs/advanced/scripts#writing-scripts-with-hardhat) æ¥éƒ¨ç½²å¯å‡çº§åˆçº¦ã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥ä½¿ç”¨ [`deployProxy`](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/api-hardhat-upgrades#deploy-proxy) éƒ¨ç½²æˆ‘ä»¬çš„å¯å‡çº§ Box åˆçº¦ã€‚æˆ‘ä»¬å°†æ­¤æ–‡ä»¶å¦å­˜ä¸º `scripts/deploy_upgradeable_box.js`ã€‚



```js
// scripts/deploy_upgradeable_box.js
const { ethers, upgrades } = require('hardhat');

async function main () {
  const Box = await ethers.getContractFactory('Box');
  console.log('Deploying Box...');
  const box = await upgrades.deployProxy(Box, [42], { initializer: 'store' });
  await box.waitForDeployment();
  console.log('Box deployed to:', await box.getAddress());
}

main();
```

ç„¶åæˆ‘ä»¬å¯ä»¥éƒ¨ç½²æˆ‘ä»¬çš„å¯å‡çº§åˆçº¦ã€‚

ä½¿ç”¨ `run` å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å°† `Box` åˆçº¦éƒ¨ç½²åˆ° `development` ç½‘ç»œã€‚



```console
$ npx hardhat run --network localhost scripts/deploy_upgradeable_box.js
Deploying Box...
Box deployed to: 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

ç„¶åæˆ‘ä»¬å¯ä»¥ä¸æˆ‘ä»¬çš„ `Box` åˆçº¦äº¤äº’ä»¥ `retrieve` æˆ‘ä»¬åœ¨åˆå§‹åŒ–æœŸé—´å­˜å‚¨çš„å€¼ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ [Hardhat console](https://hardhat.org/guides/hardhat-console.html) ä¸æˆ‘ä»¬å‡çº§åçš„ `Box` åˆçº¦è¿›è¡Œäº¤äº’ã€‚

æˆ‘ä»¬éœ€è¦æŒ‡å®šæˆ‘ä»¬åœ¨éƒ¨ç½² `Box` åˆçº¦æ—¶ä½¿ç”¨çš„ä»£ç†åˆçº¦çš„åœ°å€ã€‚



```console
$ npx hardhat console --network localhost
Welcome to Node.js v20.17.0.
Type ".help" for more information.
> const Box = await ethers.getContractFactory('Box');
undefined
> const box = await Box.attach('0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0');
undefined
> (await box.retrieve()).toString();
'42'
```

ä¸ºäº†ç¤ºä¾‹èµ·è§ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æ·»åŠ ä¸€ä¸ªæ–°åŠŸèƒ½ï¼šä¸€ä¸ªé€’å¢å­˜å‚¨åœ¨ `Box` æ–°ç‰ˆæœ¬ä¸­çš„ `value` çš„å‡½æ•°ã€‚



```solidity
// contracts/BoxV2.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract BoxV2 {
    // ... code from Box.sol
    // ... æ¥è‡ª Box.sol çš„ä»£ç 

    // Increments the stored value by 1
    // å°†å­˜å‚¨çš„å€¼é€’å¢ 1
    function increment() public {
        _value = _value + 1;
        emit ValueChanged(_value);
    }
}
```

åˆ›å»º Solidity æ–‡ä»¶åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ `upgradeProxy` å‡½æ•°å‡çº§æˆ‘ä»¬ä¹‹å‰éƒ¨ç½²çš„å®ä¾‹ã€‚

`upgradeProxy` å°†åˆ›å»ºä»¥ä¸‹äº¤æ˜“ï¼š

1. éƒ¨ç½²å®ç°åˆçº¦ï¼ˆæˆ‘ä»¬çš„ `BoxV2` åˆçº¦ï¼‰
2. è°ƒç”¨ `ProxyAdmin` ä»¥æ›´æ–°ä»£ç†åˆçº¦ä»¥ä½¿ç”¨æ–°çš„å®ç°ã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥ä½¿ç”¨ [`upgradeProxy`](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/api-hardhat-upgrades#upgrade-proxy) å°†æˆ‘ä»¬çš„ `Box` åˆçº¦å‡çº§ä¸ºä½¿ç”¨ `BoxV2`ã€‚æˆ‘ä»¬å°†æ­¤æ–‡ä»¶å¦å­˜ä¸º `scripts/upgrade_box.js`ã€‚ æˆ‘ä»¬éœ€è¦æŒ‡å®šæˆ‘ä»¬åœ¨éƒ¨ç½² `Box` åˆçº¦æ—¶ä½¿ç”¨çš„ä»£ç†åˆçº¦çš„åœ°å€ã€‚



```js
// scripts/upgrade_box.js
const { ethers, upgrades } = require('hardhat');

async function main () {
  const BoxV2 = await ethers.getContractFactory('BoxV2');
  console.log('Upgrading Box...');
  await upgrades.upgradeProxy('0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0', BoxV2);
  console.log('Box upgraded');
}

main();
```

ç„¶åæˆ‘ä»¬å¯ä»¥éƒ¨ç½²æˆ‘ä»¬çš„å¯å‡çº§åˆçº¦ã€‚

ä½¿ç”¨ `run` å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `development` ç½‘ç»œä¸Šå‡çº§ `Box` åˆçº¦ã€‚



```console
$ npx hardhat run --network localhost scripts/upgrade_box.js
Compiled 1 Solidity file successfully (evm target: paris).
Upgrading Box...
Box upgraded
```

å®Œæˆï¼æˆ‘ä»¬çš„ `Box` å®ä¾‹å·²å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„ä»£ç ï¼Œ**åŒæ—¶ä¿ç•™å…¶çŠ¶æ€å’Œä¸ä¹‹å‰ç›¸åŒçš„åœ°å€**ã€‚æˆ‘ä»¬ä¸éœ€è¦åœ¨æ–°åœ°å€éƒ¨ç½²ä¸€ä¸ªæ–°åˆçº¦ï¼Œä¹Ÿä¸éœ€è¦æ‰‹åŠ¨å°† `value` ä»æ—§ `Box` å¤åˆ¶åˆ°æ–°åˆçº¦ã€‚

è®©æˆ‘ä»¬é€šè¿‡è°ƒç”¨æ–°çš„ `increment` å‡½æ•°å¹¶æ£€æŸ¥ä¹‹åçš„ `value` æ¥å°è¯•ä¸€ä¸‹ï¼š

æˆ‘ä»¬éœ€è¦æŒ‡å®šæˆ‘ä»¬åœ¨éƒ¨ç½² `Box` åˆçº¦æ—¶ä½¿ç”¨çš„ä»£ç†åˆçº¦çš„åœ°å€ã€‚



```console
$ npx hardhat console --network localhost
Welcome to Node.js v20.17.0.
Type ".help" for more information.
> const BoxV2 = await ethers.getContractFactory('BoxV2');
undefined
> const box = await BoxV2.attach('0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0');
undefined
> await box.increment();
...
> (await box.retrieve()).toString();
'43'
```

å°±è¿™æ ·ï¼è¯·æ³¨æ„ `Box` çš„ `value` å¦‚ä½•åœ¨æ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­ä»¥åŠå…¶åœ°å€éƒ½è¢«ä¿ç•™ã€‚æ— è®ºæ‚¨æ˜¯åœ¨æœ¬åœ°åŒºå—é“¾ã€æµ‹è¯•ç½‘è¿˜æ˜¯ä¸»ç½‘ç»œä¸Šå·¥ä½œï¼Œæ­¤è¿‡ç¨‹éƒ½æ˜¯ç›¸åŒçš„ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ [OpenZeppelin Upgrades Plugins](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/) æ˜¯å¦‚ä½•å®Œæˆæ­¤æ“ä½œçš„ã€‚

## å‡çº§å¦‚ä½•å·¥ä½œ

**æœ¬èŠ‚å°†æ¯”å…¶ä»–ç« èŠ‚æ›´åé‡ç†è®ºï¼šå¦‚æœæ‚¨å¥½å¥‡ï¼Œå¯ä»¥éšæ„è·³è¿‡å¹¶åœ¨ä»¥åè¿”å›ã€‚**

å½“æ‚¨åˆ›å»ºä¸€ä¸ªæ–°çš„å¯å‡çº§åˆçº¦å®ä¾‹æ—¶ï¼Œ[OpenZeppelin Upgrades Plugins](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/) å®é™…ä¸Šä¼šéƒ¨ç½²ä¸‰ä¸ªåˆçº¦ï¼š

1. æ‚¨ç¼–å†™çš„åˆçº¦ï¼Œç§°ä¸º*å®ç°åˆçº¦*ï¼Œå…¶ä¸­åŒ…å«*é€»è¾‘*ã€‚
2. **ä»£ç†** åˆ°*å®ç°åˆçº¦*ï¼Œè¿™æ˜¯æ‚¨å®é™…ä¸ä¹‹äº¤äº’çš„åˆçº¦ã€‚
3. ä¸€ä¸ª **ProxyAdmin** ä½œä¸º **ä»£ç†** çš„ç®¡ç†å‘˜ã€‚

è¿™é‡Œï¼Œ**ä»£ç†** æ˜¯ä¸€ä¸ªç®€å•çš„åˆçº¦ï¼Œå®ƒåªæ˜¯å°†æ‰€æœ‰è°ƒç”¨*å§”æ‰˜*ç»™ä¸€ä¸ªå®ç°åˆçº¦ã€‚*å§”æ‰˜è°ƒç”¨*ç±»ä¼¼äºå¸¸è§„è°ƒç”¨ï¼Œä¸åŒä¹‹å¤„åœ¨äºæ‰€æœ‰ä»£ç éƒ½åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨è¢«è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚å› æ­¤ï¼Œå®ç°åˆçº¦ä»£ç ä¸­çš„ `transfer` å®é™…ä¸Šä¼šè½¬ç§»ä»£ç†çš„ä½™é¢ï¼Œå¹¶ä¸”å¯¹åˆçº¦å­˜å‚¨çš„ä»»ä½•è¯»å–æˆ–å†™å…¥éƒ½å°†ä»ä»£ç†è‡ªå·±çš„å­˜å‚¨ä¸­è¯»å–æˆ–å†™å…¥ã€‚

è¿™ä½¿æˆ‘ä»¬å¯ä»¥**è§£è€¦**åˆçº¦çš„çŠ¶æ€å’Œä»£ç ï¼šä»£ç†æŒæœ‰çŠ¶æ€ï¼Œè€Œå®ç°åˆçº¦æä¾›ä»£ç ã€‚å®ƒè¿˜å…è®¸æˆ‘ä»¬é€šè¿‡è®©ä»£ç†å§”æ‰˜ç»™ä¸åŒçš„å®ç°åˆçº¦æ¥**æ›´æ”¹**ä»£ç ã€‚

ç„¶åï¼Œå‡çº§åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1. éƒ¨ç½²æ–°çš„å®ç°åˆçº¦ã€‚
2. å‘ä»£ç†å‘é€ä¸€ä¸ªäº¤æ˜“ï¼Œè¯¥äº¤æ˜“å°†å…¶å®ç°åœ°å€æ›´æ–°ä¸ºæ–°çš„å®ç°åœ°å€ã€‚

æ³¨æ„ï¼šæ‚¨å¯ä»¥æœ‰å¤šä¸ªä»£ç†ä½¿ç”¨åŒä¸€ä¸ªå®ç°åˆçº¦ï¼Œå› æ­¤å¦‚æœæ‚¨è®¡åˆ’éƒ¨ç½²åŒä¸€åˆçº¦çš„å¤šä¸ªå‰¯æœ¬ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ­¤æ¨¡å¼æ¥èŠ‚çœ Gasã€‚

æ™ºèƒ½åˆçº¦çš„ä»»ä½•ç”¨æˆ·å§‹ç»ˆä¸ä»£ç†äº¤äº’ï¼Œ**ä»£ç†çš„åœ°å€æ°¸è¿œä¸ä¼šæ”¹å˜**ã€‚è¿™ä½¿æ‚¨å¯ä»¥æ¨å‡ºå‡çº§æˆ–ä¿®å¤é”™è¯¯ï¼Œè€Œæ— éœ€è¯·æ±‚æ‚¨çš„ç”¨æˆ·æ›´æ”¹ä»»ä½•å†…å®¹ - ä»–ä»¬åªéœ€åƒå¾€å¸¸ä¸€æ ·ä¸åŒä¸€åœ°å€äº¤äº’å³å¯ã€‚

æ³¨æ„ï¼šå¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº OpenZeppelin ä»£ç†å¦‚ä½•å·¥ä½œçš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [Proxies](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/proxies)ã€‚

## åˆçº¦å‡çº§çš„å±€é™æ€§

è™½ç„¶ä»»ä½•æ™ºèƒ½åˆçº¦éƒ½å¯ä»¥å‡çº§ï¼Œä½†éœ€è¦è§£å†³ Solidity è¯­è¨€çš„ä¸€äº›é™åˆ¶ã€‚è¿™äº›é™åˆ¶åœ¨ç¼–å†™åˆçº¦çš„åˆå§‹ç‰ˆæœ¬å’Œæˆ‘ä»¬å°†å‡çº§åˆ°çš„ç‰ˆæœ¬æ—¶éƒ½ä¼šå‡ºç°ã€‚

### åˆå§‹åŒ–

å¯å‡çº§åˆçº¦ä¸èƒ½æœ‰ `constructor`ã€‚ä¸ºäº†å¸®åŠ©æ‚¨è¿è¡Œåˆå§‹åŒ–ä»£ç ï¼Œ[**OpenZeppelin Contracts**](https://learnblockchain.cn/docs/openzeppelin/contracts/5.x/) æä¾›äº† [`Initializable`](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html#contracts:api:proxy.adoc#Initializable) åŸºåˆçº¦ï¼Œå®ƒå…è®¸æ‚¨å°†ä¸€ä¸ªæ–¹æ³•æ ‡è®°ä¸º [`initializer`](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html#contracts:api:proxy.adoc#Initializable-initializer--)ï¼Œç¡®ä¿å®ƒåªèƒ½è¿è¡Œä¸€æ¬¡ã€‚

ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ `Box` åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªåˆå§‹åŒ–å™¨ï¼Œç”¨äºå­˜å‚¨ `admin` çš„åœ°å€ï¼Œè¯¥ `admin` å°†æ˜¯å”¯ä¸€å…è®¸æ›´æ”¹å…¶å†…å®¹çš„äººã€‚



```solidity
// contracts/AdminBox.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";

contract AdminBox is Initializable {
    uint256 private _value;
    address private _admin;

    // Emitted when the stored value changes
    // å½“å­˜å‚¨çš„å€¼å‘ç”Ÿæ›´æ”¹æ—¶å‘å‡º
    event ValueChanged(uint256 value);

    function initialize(address admin) public initializer {
        _admin = admin;
    }

    /// @custom:oz-upgrades-unsafe-allow constructor
    // / @custom:oz-upgrades-unsafe-allow æ„é€ å‡½æ•°
    constructor() initializer {}

    // Stores a new value in the contract
    // åœ¨åˆçº¦ä¸­å­˜å‚¨ä¸€ä¸ªæ–°å€¼
    function store(uint256 value) public {
        require(msg.sender == _admin, "AdminBox: not admin");
        _value = value;
        emit ValueChanged(value);
    }

    // Reads the last stored value
    // è¯»å–æœ€åå­˜å‚¨çš„å€¼
    function retrieve() public view returns (uint256) {
        return _value;
    }
}
```

éƒ¨ç½²æ­¤åˆçº¦æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®š `initializer` å‡½æ•°åç§°ï¼ˆä»…å½“åç§°ä¸æ˜¯é»˜è®¤çš„ `initialize` æ—¶ï¼‰å¹¶æä¾›æˆ‘ä»¬è¦ä½¿ç”¨çš„ç®¡ç†å‘˜åœ°å€ã€‚



```js
// scripts/deploy_upgradeable_adminbox.js
const { ethers, upgrades } = require('hardhat');

async function main () {
  const AdminBox = await ethers.getContractFactory('AdminBox');
  console.log('Deploying AdminBox...');
  const adminBox = await upgrades.deployProxy(AdminBox, ['0xACa94ef8bD5ffEE41947b4585a84BdA5a3d3DA6E'], { initializer: 'initialize' });
  await adminBox.waitForDeployment();
  console.log('AdminBox deployed to:', await adminBox.getAddress());
}

main();
```

å¯¹äºæ‰€æœ‰å®é™…ç›®çš„è€Œè¨€ï¼Œåˆå§‹åŒ–å™¨å……å½“æ„é€ å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¯·è®°ä½ï¼Œç”±äºå®ƒæ˜¯ä¸€ä¸ªå¸¸è§„å‡½æ•°ï¼Œå› æ­¤æ‚¨éœ€è¦æ‰‹åŠ¨è°ƒç”¨æ‰€æœ‰åŸºåˆçº¦çš„åˆå§‹åŒ–å™¨ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬æ—¢åŒ…æ‹¬æ„é€ å‡½æ•°ï¼Œä¹ŸåŒ…æ‹¬åˆå§‹åŒ–å™¨ã€‚æ­¤æ„é€ å‡½æ•°çš„ä½œç”¨æ˜¯ä½¿å®ç°åˆçº¦å¤„äºå·²åˆå§‹åŒ–çŠ¶æ€ï¼Œä»è€Œç¼“è§£æŸäº›æ½œåœ¨çš„æ”»å‡»ã€‚

è¦äº†è§£æ›´å¤šå…³äºç¼–å†™å¯å‡çº§åˆçº¦æ—¶çš„æ³¨æ„äº‹é¡¹ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [ç¼–å†™å¯å‡çº§åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/writing-upgradeable) æŒ‡å—ã€‚

### å‡çº§

ç”±äºæŠ€æœ¯é™åˆ¶ï¼Œå½“æ‚¨å°†åˆçº¦å‡çº§åˆ°æ–°ç‰ˆæœ¬æ—¶ï¼Œæ‚¨æ— æ³•æ›´æ”¹è¯¥åˆçº¦çš„**å­˜å‚¨å¸ƒå±€**ã€‚

è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨å·²ç»åœ¨åˆçº¦ä¸­å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œåˆ™æ‚¨æ— æ³•åˆ é™¤å®ƒã€æ›´æ”¹å…¶ç±»å‹æˆ–åœ¨å…¶ä¹‹å‰å£°æ˜å¦ä¸€ä¸ªå˜é‡ã€‚åœ¨æˆ‘ä»¬çš„ `Box` ç¤ºä¾‹ä¸­ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åªèƒ½åœ¨ `value` _ä¹‹å_æ·»åŠ æ–°çš„çŠ¶æ€å˜é‡ã€‚



```solidity
// contracts/Box.sol
contract Box {
    uint256 private _value;

    // We can safely add a new variable after the ones we had declared
    // æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°åœ¨æˆ‘ä»¬å£°æ˜çš„å˜é‡ä¹‹åæ·»åŠ ä¸€ä¸ªæ–°å˜é‡
    address private _owner;

    // ...
}
```

å¹¸è¿çš„æ˜¯ï¼Œæ­¤é™åˆ¶ä»…å½±å“çŠ¶æ€å˜é‡ã€‚æ‚¨å¯ä»¥éšæ„æ›´æ”¹åˆçº¦çš„å‡½æ•°å’Œäº‹ä»¶ã€‚

æ³¨æ„ï¼šå¦‚æœæ‚¨ä¸å°å¿ƒæç ¸äº†åˆçº¦çš„å­˜å‚¨å¸ƒå±€ï¼ŒUpgrades Plugins ä¼šåœ¨æ‚¨å°è¯•å‡çº§æ—¶å‘å‡ºè­¦å‘Šã€‚

è¦äº†è§£æ›´å¤šå…³äºæ­¤é™åˆ¶çš„ä¿¡æ¯ï¼Œè¯·è®¿é—® [ä¿®æ”¹æ‚¨çš„åˆçº¦](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/writing-upgradeable#modifying-your-contracts) æŒ‡å—ã€‚

## æµ‹è¯•

ä¸ºäº†æµ‹è¯•å¯å‡çº§åˆçº¦ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºå®ç°åˆçº¦åˆ›å»ºå•å…ƒæµ‹è¯•ï¼ŒåŒæ—¶åˆ›å»ºæ›´é«˜çº§åˆ«çš„æµ‹è¯•ä»¥æµ‹è¯•é€šè¿‡ä»£ç†çš„äº¤äº’ã€‚æˆ‘ä»¬å¯ä»¥åƒéƒ¨ç½²æ—¶ä¸€æ ·åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¸­ä½¿ç”¨ `deployProxy`ã€‚

å½“æˆ‘ä»¬æƒ³è¦å‡çº§æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºæ–°çš„å®ç°åˆçº¦åˆ›å»ºå•å…ƒæµ‹è¯•ï¼ŒåŒæ—¶åœ¨å‡çº§åä½¿ç”¨ `upgradeProxy` åˆ›å»ºæ›´é«˜çº§åˆ«çš„æµ‹è¯•ï¼Œä»¥æµ‹è¯•é€šè¿‡ä»£ç†çš„äº¤äº’ï¼Œæ£€æŸ¥çŠ¶æ€æ˜¯å¦åœ¨å‡çº§è¿‡ç¨‹ä¸­ä¿æŒä¸å˜ã€‚

## å¯èƒ½çš„é—®é¢˜

åœ¨å­¦ä¹ å¦‚ä½•å‡çº§åˆçº¦æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°è‡ªå·±å¤„äºæœ¬åœ°ç¯å¢ƒä¸­åˆçº¦å†²çªçš„æƒ…å†µã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤ï¼š

åœæ­¢ä½¿ç”¨ `npx hardhat node` è¿è¡Œçš„èŠ‚ç‚¹ ctrl+Cã€‚æ‰§è¡Œæ¸…ç†ï¼š`npx hardhat clean`ã€‚

## åç»­æ­¥éª¤



# å‡†å¤‡ä¸Šçº¿ä¸»ç½‘

åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ [åœ¨æµ‹è¯•ç½‘ä¸Šè¿è¡Œä½ çš„é¡¹ç›®](https://learnblockchain.cn/docs/openzeppelin/learn/connecting-to-public-test-networks.html)ä¸”æ²¡æœ‰é—®é¢˜åï¼Œä½ å¯èƒ½æƒ³å°†å…¶éƒ¨ç½²åˆ°ä»¥å¤ªåŠä¸»ç½‘ç»œï¼ˆä¹Ÿç§°ä½œ *mainnet*ï¼‰ã€‚ä½†æ˜¯ï¼Œä¸Šçº¿ä¸»ç½‘çš„è®¡åˆ’åº”è¯¥æ¯”ä½ è®¡åˆ’çš„å‘å¸ƒæ—¥æœŸæ›´æ—©å¼€å§‹ã€‚

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä»¥å¤ªåŠç‰¹å®šçš„æ³¨æ„äº‹é¡¹ï¼Œä»¥ä¾¿å°†ä½ çš„é¡¹ç›®æŠ•å…¥ç”Ÿäº§ï¼Œä¾‹å¦‚ï¼š

- [å®¡è®¡å’Œå®‰å…¨](https://learnblockchain.cn/docs/openzeppelin/learn/preparing-for-mainnet.html#auditing-and-security)
- [éªŒè¯æºä»£ç ](https://learnblockchain.cn/docs/openzeppelin/learn/preparing-for-mainnet.html#verify-source-code)
- [å®‰å…¨åœ°ç®¡ç†å¯†é’¥](https://learnblockchain.cn/docs/openzeppelin/learn/preparing-for-mainnet.html#key-management)
- [å¤„ç†é¡¹ç›®ç®¡ç†](https://learnblockchain.cn/docs/openzeppelin/learn/preparing-for-mainnet.html#project-governance)

è¯·è®°ä½ï¼Œè™½ç„¶åœ¨æŠ€æœ¯ä¸Šç®¡ç†ä½ åœ¨æµ‹è¯•ç½‘å’Œä¸»ç½‘ä¸­çš„åˆçº¦æ˜¯ç›¸åŒçš„ï¼Œä½†åœ¨ä¸»ç½‘ä¸Šå­˜åœ¨é‡è¦çš„å·®å¼‚ï¼Œå› ä¸ºä½ çš„é¡¹ç›®ç°åœ¨ä¸ºä½ çš„ç”¨æˆ·ç®¡ç†ç€çœŸæ­£çš„ä»·å€¼ã€‚

## å®¡è®¡å’Œå®‰å…¨

è™½ç„¶å®‰å…¨æ€§ä¼šå½±å“æ‰€æœ‰çš„è½¯ä»¶å¼€å‘ï¼Œä½†æ™ºèƒ½åˆçº¦ä¸­çš„å®‰å…¨æ€§å°¤ä¸ºé‡è¦ã€‚ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ä»»ä½• payload ç›´æ¥å‘ä½ çš„åˆçº¦å‘é€äº¤æ˜“ï¼Œå¹¶ä¸”ä½ æ‰€æœ‰çš„åˆçº¦ä»£ç å’ŒçŠ¶æ€éƒ½æ˜¯å…¬å¼€å¯è®¿é—®çš„ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¦‚æœä½ è¢«é»‘å®¢æ”»å‡»ï¼Œåˆ™æ— æ³•è¿½å›è¢«ç›—èµ„é‡‘ - å®ƒä»¬åœ¨å»ä¸­å¿ƒåŒ–ç½‘ç»œä¸­æ°¸è¿œæ¶ˆå¤±äº†ã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œå®‰å…¨åº”è¯¥æ˜¯å¼€å‘å„ä¸ªé˜¶æ®µçš„é¦–è¦è€ƒè™‘å› ç´ ã€‚è¿™æ„å‘³ç€ **å®‰å…¨ä¸æ˜¯ä½ åœ¨å‘å¸ƒå‰ä¸€å‘¨æ·»åŠ åˆ°é¡¹ç›®ä¸­çš„ä¸œè¥¿**ï¼Œè€Œæ˜¯ä»é¡¹ç›®çš„ç¬¬ä¸€å¤©å¼€å§‹çš„æŒ‡å¯¼åŸåˆ™ã€‚

åœ¨å¼€å§‹ç¼–ç æ—¶ï¼Œè¯·æŸ¥çœ‹ [æ™ºèƒ½åˆçº¦å®‰å…¨æœ€ä½³å®è·µ](https://consensys.github.io/smart-contract-best-practices/)ï¼ŒåŠ å…¥ [æˆ‘ä»¬è®ºå›ä¸­çš„å®‰å…¨è®¨è®º](https://forum.openzeppelin.com/c/security/25?__hstc=64374704.8add8e9ba7adde50f6ef2419f1c8aad3.1765351015574.1765415709589.1765420487001.5&__hssc=64374704.20.1765420487001&__hsfp=1007129867)ï¼Œå¹¶åŠ¡å¿…æŸ¥çœ‹æˆ‘ä»¬çš„ [è´¨é‡æ¸…å•](https://blog.openzeppelin.com/follow-this-quality-checklist-before-an-audit-8cc6a0e44845/?__hstc=64374704.8add8e9ba7adde50f6ef2419f1c8aad3.1765351015574.1765415709589.1765420487001.5&__hssc=64374704.20.1765420487001&__hsfp=1007129867)ï¼Œä»¥ç¡®ä¿ä½ çš„é¡¹ç›®æ˜¯å¥åº·çš„ã€‚

å®Œæˆåï¼Œç°åœ¨æ˜¯æ—¶å€™å‘ä¸€å®¶æˆ–å¤šå®¶å®¡è®¡å…¬å¸è¯·æ±‚å®¡è®¡äº†ã€‚ä½ å¯ä»¥ä» OpenZeppelin Research Team [è¯·æ±‚å®¡è®¡](https://openzeppelin.com/security-audits/?__hstc=64374704.8add8e9ba7adde50f6ef2419f1c8aad3.1765351015574.1765415709589.1765420487001.5&__hssc=64374704.20.1765420487001&__hsfp=1007129867) - æˆ‘ä»¬æ˜¯ä¸€æ”¯ç»éªŒä¸°å¯Œçš„å›¢é˜Ÿï¼Œæ‹¥æœ‰ [æ‚ ä¹…çš„è®°å½•](https://blog.openzeppelin.com/security-audits/?__hstc=64374704.8add8e9ba7adde50f6ef2419f1c8aad3.1765351015574.1765415709589.1765420487001.5&__hssc=64374704.20.1765420487001&__hsfp=1007129867)ã€‚

è¯·è®°ä½ï¼Œå®¡è®¡ä¸èƒ½ç¡®ä¿æ²¡æœ‰é”™è¯¯ï¼Œä½†è®©å‡ ä½ç»éªŒä¸°å¯Œçš„å®‰å…¨ç ”ç©¶äººå‘˜æ£€æŸ¥ä½ çš„ä»£ç è‚¯å®šä¼šæœ‰æ‰€å¸®åŠ©ã€‚

## éªŒè¯ä½ çš„æºä»£ç 

åœ¨å°†åˆçº¦éƒ¨ç½²åˆ°ä¸»ç½‘åï¼Œä½ åº”è¯¥ç«‹å³ **éªŒè¯ä»–ä»¬çš„æºä»£ç **ã€‚æ­¤è¿‡ç¨‹æ¶‰åŠå°† Solidity ä»£ç æäº¤ç»™ç¬¬ä¸‰æ–¹ï¼Œä¾‹å¦‚ [Etherscan](https://etherscan.io/) æˆ– [Sourcify](https://sourcify.dev/)ï¼Œä»–ä»¬å°†å¯¹å…¶è¿›è¡Œç¼–è¯‘å¹¶_éªŒè¯_å®ƒæ˜¯å¦ä¸å·²éƒ¨ç½²çš„æ±‡ç¼–ä»£ç åŒ¹é…ã€‚è¿™å…è®¸ä»»ä½•ç”¨æˆ·æŸ¥çœ‹ä½ çš„åˆçº¦ä»£ç ï¼ˆå¦‚åœ¨åŒºå—æµè§ˆå™¨ä¸­ï¼‰ï¼Œå¹¶çŸ¥é“å®ƒå¯¹åº”äºåœ¨è¯¥åœ°å€å®é™…è¿è¡Œçš„æ±‡ç¼–ä»£ç ã€‚

ä½ å¯ä»¥åœ¨ [Etherscan](https://etherscan.io/verifyContract) ç½‘ç«™ä¸Šæ‰‹åŠ¨éªŒè¯ä½ çš„åˆçº¦ã€‚

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ [hardhat-verify plugin](https://hardhat.org/hardhat-runner/plugins/nomicfoundation-hardhat-verify)ã€‚

ä¸ºæ­¤ï¼Œè¯·å®‰è£…è¯¥æ’ä»¶ï¼š



```console
npm install --save-dev @nomicfoundation/hardhat-verify
```

æ›´æ–°ä½ çš„ hardhat é…ç½®ï¼š



```js
// hardhat.config.js
const { etherscanApiKey, projectId, mnemonic } = require('./secrets.json');
require("@nomicfoundation/hardhat-verify");
...
module.exports = {
  networks: {
    mainnet: { ... }
  },
  etherscan: {
    apiKey: etherscanApiKey
  }
};
```

æœ€åï¼Œè¿è¡Œ `verify` ä»»åŠ¡ï¼Œä¼ é€’åˆçº¦çš„åœ°å€ã€å®ƒéƒ¨ç½²åˆ°çš„ç½‘ç»œä»¥åŠç”¨äºéƒ¨ç½²å®ƒçš„æ„é€ å‡½æ•°å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š



```console
npx hardhat verify --network mainnet DEPLOYED_CONTRACT_ADDRESS "Constructor argument 1"
```

|      | ä½ å°†éœ€è¦ä¸€ä¸ª [Etherscan API å¯†é’¥](https://etherscan.io/apis)æ‰èƒ½ä½¿ç”¨ä»–ä»¬çš„æœåŠ¡ã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

|      | å½“ä½ éƒ¨ç½²å¯å‡çº§åˆçº¦æ—¶ï¼Œç”¨æˆ·ä¸ä¹‹äº¤äº’çš„åˆçº¦å°†åªæ˜¯ä¸€ä¸ªä»£ç†ï¼Œå®é™…é€»è¾‘å°†åœ¨å®ç°åˆçº¦ä¸­ã€‚Etherscan ç¡®å® [æ”¯æŒæ­£ç¡®æ˜¾ç¤º OpenZeppelin ä»£ç†åŠå…¶å®ç°](https://medium.com/etherscan-blog/and-finally-proxy-contract-support-on-etherscan-693e3da0714b)ï¼Œä½†å…¶ä»–æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

## å¯†é’¥ç®¡ç†

åœ¨ä¸»ç½‘ä¸Šå·¥ä½œæ—¶ï¼Œä½ éœ€è¦ç‰¹åˆ«æ³¨æ„ä¿æŠ¤ä½ çš„ç§é’¥ã€‚ä½ ç”¨äºéƒ¨ç½²åˆçº¦å¹¶ä¸ä¹‹äº¤äº’çš„å¸æˆ·å°†æŒæœ‰çœŸæ­£çš„ Etherï¼Œè¿™å…·æœ‰çœŸæ­£çš„ä»·å€¼ï¼Œå¹¶ä¸”å¯¹äºé»‘å®¢æ¥è¯´æ˜¯ä¸€ä¸ªè¯±äººçš„ç›®æ ‡ã€‚é‡‡å–ä¸€åˆ‡é¢„é˜²æªæ–½æ¥ä¿æŠ¤ä½ çš„å¯†é’¥ï¼Œå¹¶åœ¨å¿…è¦æ—¶è€ƒè™‘ä½¿ç”¨ [ç¡¬ä»¶é’±åŒ…](https://ethereum.org/en/security/#use-hardware-wallet)ã€‚

|      | ä¸æµ‹è¯•ç½‘ä¸åŒï¼Œä½ æ— æ³•ä» faucet è·å–ä¸»ç½‘ Etherã€‚ä½ éœ€è¦å‰å¾€äº¤æ˜“æ‰€äº¤æ˜“å…¶ä»– coins æˆ– fiatï¼Œä»¥è·å–ç”¨äºéƒ¨ç½²åˆçº¦çš„çœŸå® Etherã€‚ |
| ---- | ------------------------------------------------------------ |
|      |                                                              |

æ­¤å¤–ï¼Œä½ å¯ä»¥å®šä¹‰æŸäº›å¸æˆ·åœ¨ä½ çš„ç³»ç»Ÿä¸­æ‹¥æœ‰ç‰¹æ®Šæƒé™ - ä½ åº”è¯¥æ ¼å¤–å°å¿ƒåœ°ä¿æŠ¤å®ƒä»¬ã€‚

### ç®¡ç†å‘˜å¸æˆ·

*admin*ï¼ˆ*administrator* çš„ç¼©å†™ï¼‰å¸æˆ·æ˜¯åœ¨ä½ çš„ç³»ç»Ÿä¸­å…·æœ‰ç‰¹æ®Šæƒé™çš„å¸æˆ·ã€‚ä¾‹å¦‚ï¼Œç®¡ç†å‘˜å¯èƒ½æœ‰æƒ [æš‚åœ](https://learnblockchain.cn/docs/openzeppelin/learn/preparing-for-mainnet.html#contracts:api:utils.adoc#Pausable)åˆçº¦ã€‚å¦‚æœè¿™æ ·çš„å¸æˆ·è½å…¥æ¶æ„ç”¨æˆ·æ‰‹ä¸­ï¼Œä»–ä»¬å¯èƒ½ä¼šåœ¨ä½ çš„ç³»ç»Ÿä¸­é€ æˆä¸¥é‡ç ´åã€‚

ä¿æŠ¤ç®¡ç†å‘˜å¸æˆ·çš„ä¸€ä¸ªå¥½é€‰æ‹©æ˜¯ä½¿ç”¨ç‰¹æ®Šçš„åˆçº¦ï¼Œä¾‹å¦‚ multisigï¼Œè€Œä¸æ˜¯å¸¸è§„çš„å¤–éƒ¨æ‰€æœ‰å¸æˆ·ã€‚*multisig* æ˜¯ä¸€ç§å¯ä»¥æ‰§è¡Œä»»ä½•æ“ä½œçš„åˆçº¦ï¼Œ*åªè¦é¢„å®šä¹‰æ•°é‡çš„å—ä¿¡ä»»æˆå‘˜åŒæ„å³å¯*ã€‚https://safe.global/wallet[Safe] æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ multisigã€‚

### å‡çº§ç®¡ç†å‘˜

åœ¨ [OpenZeppelin Upgrades Plugins](https://learnblockchain.cn/docs/openzeppelin/upgrades-plugins/) é¡¹ç›®ä¸­ï¼Œä¸€ä¸ªç‰¹æ®Šçš„ç®¡ç†å‘˜å¸æˆ·æ˜¯æœ‰æƒ [*å‡çº§*](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html) å…¶ä»–åˆçº¦çš„å¸æˆ·ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç”¨äºéƒ¨ç½²åˆçº¦çš„å¤–éƒ¨æ‰€æœ‰å¸æˆ·ï¼šè™½ç„¶è¿™å¯¹äºæœ¬åœ°æˆ–æµ‹è¯•ç½‘éƒ¨ç½²æ¥è¯´å·²ç»è¶³å¤Ÿå¥½ï¼Œä½†åœ¨ä¸»ç½‘ä¸Šï¼Œä½ éœ€è¦æ›´å¥½åœ°ä¿æŠ¤ä½ çš„åˆçº¦ã€‚å¦‚æœæ”»å‡»è€…è·å¾—äº†ä½ çš„å‡çº§ç®¡ç†å‘˜å¸æˆ·ï¼Œä»–ä»¬å¯ä»¥æ›´æ”¹ä½ ç³»ç»Ÿä¸­çš„ä»»ä½•åˆçº¦ï¼

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œæœ€å¥½åœ¨éƒ¨ç½²å **æ›´æ”¹ ProxyAdmin çš„æ‰€æœ‰æƒ** - ä¾‹å¦‚ï¼Œæ›´æ”¹ä¸º multisigã€‚ä¸ºæ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ `admin.transferProxyAdminOwnership` æ¥è½¬ç§»æˆ‘ä»¬çš„ `ProxyAdmin` åˆçº¦çš„æ‰€æœ‰æƒã€‚

å½“ä½ éœ€è¦å‡çº§ä½ çš„åˆçº¦æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `prepareUpgrade` æ¥éªŒè¯å’Œéƒ¨ç½²ä¸€ä¸ªæ–°çš„å®ç°åˆçº¦ï¼Œè¯¥åˆçº¦å·²å‡†å¤‡å¥½åœ¨æˆ‘ä»¬çš„ä»£ç†æ›´æ–°æ—¶ä½¿ç”¨ã€‚

## é¡¹ç›®ç®¡ç†

å¯ä»¥è®¤ä¸ºï¼Œç®¡ç†å‘˜å¸æˆ·åæ˜ äº†ä¸€ä¸ªé¡¹ç›®å®é™…ä¸Šä¸æ˜¯ *å»ä¸­å¿ƒåŒ–çš„*ã€‚æ¯•ç«Ÿï¼Œå¦‚æœä¸€ä¸ªå¸æˆ·å¯ä»¥å•æ–¹é¢æ›´æ”¹ç³»ç»Ÿä¸­çš„ä»»ä½•åˆçº¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¹¶ä¸æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªå®Œå…¨æ— éœ€ä¿¡ä»»çš„ç¯å¢ƒã€‚

è¿™å°±æ˜¯ *æ²»ç†* çš„ç”¨æ­¦ä¹‹åœ°ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä½ çš„é¡¹ç›®ä¸­ä¼šæœ‰ä¸€äº›æ“ä½œéœ€è¦ç‰¹æ®Šæƒé™ï¼Œä»å¾®è°ƒç³»ç»Ÿå‚æ•°åˆ°è¿è¡Œå®Œæ•´çš„åˆçº¦å‡çº§ã€‚ä½ éœ€è¦é€‰æ‹©å¦‚ä½•å†³å®šè¿™äº›æ“ä½œï¼šæ˜¯ç”±ä¸€ [å°ç¾¤](https://safe.global/wallet) å—ä¿¡ä»»çš„å¼€å‘äººå‘˜å†³å®šï¼Œè¿˜æ˜¯ç”±æ‰€æœ‰é¡¹ç›®å¹²ç³»äºº [å…¬å¼€æŠ•ç¥¨](https://learnblockchain.cn/docs/openzeppelin/contracts/5.x/governance) å†³å®šã€‚

è¿™é‡Œæ²¡æœ‰æ­£ç¡®çš„ç­”æ¡ˆã€‚ä½ ä¸ºä½ çš„é¡¹ç›®é€‰æ‹©å“ªç§æ²»ç†æ–¹æ¡ˆå°†åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºä½ æ­£åœ¨æ„å»ºçš„å†…å®¹ä»¥åŠä½ çš„ç¤¾åŒºæ˜¯è°ã€‚

## ä¸‹ä¸€æ­¥

æ­å–œä½ ï¼ä½ å·²ç»èµ°åˆ°äº†å¼€å‘æ—…ç¨‹çš„å°½å¤´ï¼Œä»ç¼–å†™ä½ çš„ç¬¬ä¸€ä¸ªåˆçº¦åˆ°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ä½†æ˜¯å·¥ä½œè¿œæœªç»“æŸã€‚ç°åœ¨ä½ å¿…é¡»å¼€å§‹æ”¶é›†å®æ—¶ç”¨æˆ·åé¦ˆã€å‘ä½ çš„ç³»ç»Ÿæ·»åŠ æ–°åŠŸèƒ½ï¼ˆé€šè¿‡åˆçº¦å‡çº§å®ç°ï¼ï¼‰ã€ç›‘æ§ä½ çš„åº”ç”¨ç¨‹åºï¼Œå¹¶æœ€ç»ˆæ‰©å±•ä½ çš„é¡¹ç›®ã€‚

åœ¨æœ¬ç½‘ç«™ä¸Šï¼Œä½ å¯ä»¥éšæ„ä½¿ç”¨ OpenZeppelin å¹³å°ä¸­æ‰€æœ‰é¡¹ç›®çš„è¯¦ç»†æŒ‡å—å’Œå‚è€ƒï¼Œå› æ­¤ä½ å¯ä»¥é€‰æ‹©ä½ éœ€è¦æ„å»ºä»¥å¤ªåŠåº”ç”¨ç¨‹åºçš„ä»»ä½•å†…å®¹ã€‚ç¥ä½ ç¼–ç æ„‰å¿«ï¼

[â† Upgrading smart contracts](https://learnblockchain.cn/docs/openzeppelin/learn/upgrading-smart-contracts.html)